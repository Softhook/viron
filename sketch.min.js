const TILE=120,SEA=200,LAUNCH_ALT=100,GRAV=.09;let VIEW_NEAR=35,VIEW_FAR=50,CULL_DIST=6e3;const SKY_R=30,SKY_G=60,SKY_B=120,ORTHO_DIRS=[[1,0],[-1,0],[0,1],[0,-1]],MAX_INF=2e3,INF_RATE=.01,CLEAR_R=3,LAUNCH_MIN=0,LAUNCH_MAX=840,TREE_VARIANTS=[{infected:[180,30,20],healthy:[25,130,20],cones:[[12,45,20]]},{infected:[190,35,25],healthy:[30,145,25],cones:[[22,28,10]],infected2:[150,20,15],healthy2:[25,120,20],cones2:[[15,22,28]]},{infected:[170,30,22],healthy:[35,135,28],cones:[[9,60,28]]}],YAW_RATE=.04,PITCH_RATE=.04,MOUSE_SENSITIVITY=.003,MOUSE_SMOOTHING=.25,P1_KEYS={thrust:87,left:65,right:68,brake:83,pitchUp:82,pitchDown:70,shoot:81,missile:69},P2_KEYS={thrust:38,left:37,right:39,brake:40,pitchUp:186,pitchDown:222,shoot:190,missile:191};let gameFont,trees=[],particles=[],enemies=[],buildings=[],bombs=[],enemyBullets=[],infectedTiles={},level=1,currentMaxEnemies=2,levelComplete=!1,infectionStarted=!1,levelEndTime=0,activePulses=[],gameState="menu",gameOverReason="",lastAlarmTime=0,gameStartTime=0,numPlayers=1,menuStars=[],mouseReleasedSinceStart=!0,leftMouseDown=!1,rightMouseDown=!1,players=[],altCache=new Map,smoothedMX=0,smoothedMY=0;const CHUNK_SIZE=16;let terrainShader,chunkCache=new Map,isMobile=!1,isAndroid=!1;function checkMobile(){isAndroid=/Android/i.test(navigator.userAgent),isMobile=isAndroid||/iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window}const tileKey=(e,t)=>e+","+t,toTile=e=>Math.floor(e/120),isLaunchpad=(e,t)=>e>=0&&e<=840&&t>=0&&t<=840,aboveSea=e=>e>=199,getSpawnX=e=>1===numPlayers?420:0===e.id?320:520;function setSceneLighting(){directionalLight(240,230,210,.5,.8,-.3),ambientLight(60,60,70)}function addPulse(e,t,l=0){activePulses=[{x:e,z:t,start:millis()/1e3,type:l},...activePulses].slice(0,5)}function inFrustum(e,t,l){let i=t-e.x,o=l-e.z,r=i*e.fwdX+o*e.fwdZ;if(r<-600)return!1;let n=i*-e.fwdZ+o*e.fwdX,a=(r>0?r:0)*(.57735*((1===numPlayers?width:.5*width)/height)+.3)+720;return Math.abs(n)<=a}function getCameraParams(e){let t=-sin(e.yaw),l=-cos(e.yaw);return{x:e.x-550*t,z:e.z-550*l,fwdX:t,fwdZ:l}}function shipUpDir(e){let t=sin(e.pitch),l=cos(e.pitch);return{x:t*-sin(e.yaw),y:-l,z:t*-cos(e.yaw)}}function resetShip(e,t){e.ship={x:t,y:100,z:420,vx:0,vy:0,vz:0,pitch:0,yaw:0}}function createPlayer(e,t,l,i){let o={id:e,keys:t,labelColor:i,score:0,dead:!1,respawnTimer:0,bullets:[],homingMissiles:[],missilesRemaining:1,mobileMissilePressed:!1};return resetShip(o,l),o}function fireMissile(e){e.missilesRemaining>0&&!e.dead&&(e.missilesRemaining--,e.homingMissiles.push(spawnProjectile(e.ship,8,300)),"undefined"!=typeof gameSFX&&gameSFX.playMissileFire(e.ship.x,e.ship.y,e.ship.z))}function drawShadow(e,t,l,i,o){aboveSea(t)||(push(),translate(e,t-.5,l),rotateX(PI/2),fill(0,0,0,50),ellipse(0,0,i,o),pop())}function drawShipShadow(e,t,l,i,o){if(aboveSea(t))return;let r=max(1,.012*(t-o)),n=map(t-o,0,600,60,15,!0);push(),translate(e,t-.3,l),rotateY(i),noStroke(),fill(0,0,0,n),beginShape(),vertex(-15*r,0,15*r),vertex(15*r,0,15*r),vertex(0,0,-25*r),endShape(CLOSE),pop()}function setup2DViewport(){let e=pixelDensity();drawingContext.viewport(0,0,width*e,height*e),push(),ortho(-width/2,width/2,-height/2,height/2,0,1e3),resetMatrix()}function clearInfectionRadius(e,t){let l=0;for(let i=-3;i<=3;i++)for(let o=-3;o<=3;o++){let r=tileKey(e+i,t+o);infectedTiles[r]&&(delete infectedTiles[r],l++)}return l}function findNearest(e,t,l,i){let o=null,r=1/0;for(let n of e){let e=(t-n.x)**2+(l-n.y)**2+(i-n.z)**2;e<r&&(r=e,o=n)}return o}function spawnProjectile(e,t,l){let i=cos(e.pitch),o=sin(e.pitch),r=cos(e.yaw),n=sin(e.yaw),a=-i*n,s=o,p=-i*r,f=10*i- -30*o,d=10*o+-30*i;return{x:e.x+d*n,y:e.y+f,z:e.z+d*r,vx:a*t+e.vx,vy:s*t+e.vy,vz:p*t+e.vz,life:l}}const TERRAIN_VERT="\nprecision highp float;\nattribute vec3 aPosition;\nattribute vec4 aVertexColor;\nuniform mat4 uProjectionMatrix;\nuniform mat4 uModelViewMatrix;\nvarying vec4 vColor;\nvarying vec4 vWorldPos;\n\nvoid main() {\n  vec4 viewSpace = uModelViewMatrix * vec4(aPosition, 1.0);\n  gl_Position = uProjectionMatrix * viewSpace;\n  vWorldPos = vec4(aPosition, 1.0);\n  vColor = aVertexColor;\n}\n",TERRAIN_FRAG='\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vWorldPos;\nuniform float uTime;\nuniform vec4 uPulses[5];\nuniform vec2 uFogDist;\n\nfloat hash(vec2 p) {\n  p = fract(p * vec2(123.34, 456.21));\n  p += dot(p, p + 45.32);\n  return fract(p.x * p.y);\n}\n\nvec2 hash2(vec2 p) {\n  return fract(sin(vec2(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)))) * 43758.5453);\n}\n\nfloat noise(vec2 p) {\n  vec2 i = floor(p);\n  vec2 f = fract(p);\n  vec2 u = f * f * (3.0 - 2.0 * f);\n  return mix(\n    mix(hash(i + vec2(0.0, 0.0)), hash(i + vec2(1.0, 0.0)), u.x),\n    mix(hash(i + vec2(0.0, 1.0)), hash(i + vec2(1.0, 1.0)), u.x), u.y);\n}\n\nfloat fbm(vec2 p) {\n  float f = 0.0;\n  float amp = 0.5;\n  for(int i = 0; i < 3; i++) {\n    f += amp * noise(p);\n    p *= 2.0;\n    amp *= 0.5;\n  }\n  return f;\n}\n\nvoid main() {  \n  vec3 cyberColor = vec3(0.0);\n  \n  vec3 baseColor = vColor.rgb;\n  vec3 texColor = baseColor;\n  \n  if (vWorldPos.y > 199.0) {\n    // Subtle, clean ripple/caustic style inspired by reference image\n    vec2 uv = vWorldPos.xz * 0.01; \n    uv += vec2(uTime * 0.02, uTime * 0.015); // Much slower flow\n    \n    // Multi-layered Voronoi/Noise for a "caustic" look\n    float ripple = 0.0;\n    \n    // First layer\n    vec2 pos1 = uv;\n    vec2 p1 = floor(pos1);\n    vec2 f1 = fract(pos1);\n    float minDist1 = 1.0;\n    for(int y = -1; y <= 1; y++) {\n      for(int x = -1; x <= 1; x++) {\n        vec2 neighbor = vec2(float(x), float(y));\n        vec2 pt = hash2(p1 + neighbor);\n        pt = 0.5 + 0.5 * sin(uTime * 0.4 + 6.2831 * pt);\n        minDist1 = min(minDist1, length(neighbor + pt - f1));\n      }\n    }\n    \n    // Second layer at different scale\n    vec2 pos2 = uv * 2.5 + vec2(uTime * 0.1);\n    vec2 p2 = floor(pos2);\n    vec2 f2 = fract(pos2);\n    float minDist2 = 1.0;\n    for(int y = -1; y <= 1; y++) {\n      for(int x = -1; x <= 1; x++) {\n        vec2 neighbor = vec2(float(x), float(y));\n        vec2 pt = hash2(p2 + neighbor);\n        pt = 0.5 + 0.5 * sin(uTime * 0.6 + 6.2831 * pt);\n        minDist2 = min(minDist2, length(neighbor + pt - f2));\n      }\n    }\n    \n    // Combine layers to get "thin" lines (caustics)\n    ripple = pow(minDist1, 0.5) * minDist2; \n    \n    // Toon-shading style thresholds for highlights\n    float highlight = smoothstep(0.3, 0.35, ripple);\n    \n    // Even more subtle water colors, almost identical\n    vec3 shallow = vec3(0.13, 0.68, 0.73); \n    vec3 deep = vec3(0.12, 0.65, 0.7);   \n    \n    texColor = mix(shallow, deep, ripple);\n    \n    // Very faint caustic highlights\n    float caustic = smoothstep(0.75, 0.85, 1.0 - ripple);\n    texColor += vec3(0.04, 0.05, 0.05) * caustic; \n\n  } else {\n    // Solid Landscape: plain untextured appearance \n    // Uses the raw base color coming from the vertex buffer without any noise overlay\n    texColor = baseColor;\n  }\n\n  // Bomb drop pulses\n  for (int i = 0; i < 5; i++) {\n    float age = uTime - uPulses[i].z;\n    if (age >= 0.0 && age < 3.0) { // Lasts for 3 seconds\n      float type = uPulses[i].w;\n      // Scale differences by 0.01 before taking length to avoid fp16 overflow on mobile\n      vec2 diff = (vWorldPos.xz - uPulses[i].xy) * 0.01;\n      float distToPulse = length(diff) * 100.0;\n      \n      float radius = type == 1.0 ? age * 300.0 : (type == 2.0 ? age * 1200.0 : age * 800.0); // type 2 is ship explosion\n      float ringThickness = type == 1.0 ? 30.0 : (type == 2.0 ? 150.0 : 80.0);\n      float ring = smoothstep(radius - ringThickness, radius, distToPulse) * (1.0 - smoothstep(radius, radius + ringThickness, distToPulse));\n      \n      float fade = 1.0 - (age / 3.0);\n      vec3 pulseColor = type == 1.0 ? vec3(0.2, 0.6, 1.0) : (type == 2.0 ? vec3(1.0, 0.8, 0.2) : vec3(1.0, 0.1, 0.1)); // Blue crab, yellow ship, red bomb\n      cyberColor += pulseColor * ring * fade * 2.0; \n    }\n  }\n  \n  vec3 outColor = texColor + cyberColor;\n  \n  // Apply fog to smoothly hide chunk loading edges\n  float dist = gl_FragCoord.z / gl_FragCoord.w;\n  float fogFactor = smoothstep(uFogDist.x, uFogDist.y, dist);\n  vec3 fogColor = vec3(30.0 / 255.0, 60.0 / 255.0, 120.0 / 255.0);\n  outColor = mix(outColor, fogColor, fogFactor);\n\n  gl_FragColor = vec4(outColor, vColor.a);\n}\n';function preload(){gameFont=loadFont("Impact.ttf")}function setup(){checkMobile(),isMobile&&(VIEW_NEAR=20,VIEW_FAR=30,CULL_DIST=3500),createCanvas(windowWidth,windowHeight,WEBGL),document.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("mousedown",e=>{0===e.button&&(leftMouseDown=!0),1===e.button&&e.preventDefault(),2===e.button&&(rightMouseDown=!0)}),document.addEventListener("mouseup",e=>{0===e.button&&(leftMouseDown=!1),2===e.button&&(rightMouseDown=!1)}),terrainShader=createShader(TERRAIN_VERT,TERRAIN_FRAG),textFont(gameFont),randomSeed(42);let e=isMobile?80:250;for(let t=0;t<e;t++)trees.push({x:random(-5e3,5e3),z:random(-5e3,5e3),variant:floor(random(3)),trunkH:random(25,50),canopyScale:random(1,1.8)});let t=isMobile?50:120;for(let e=0;e<t;e++)menuStars.push({x:random(-1,1),y:random(-1,1),s:random(1,3),spd:random(.3,1.2)});randomSeed(123);let l=isMobile?15:40;for(let e=0;e<l;e++)buildings.push({x:random(-4500,4500),z:random(-4500,4500),w:random(40,100),h:random(50,180),d:random(40,100),type:floor(random(4)),col:[random(80,200),random(80,200),random(80,200)]});gameState="menu"}function startGame(e){numPlayers=e,gameStartTime=millis(),mouseReleasedSinceStart=!leftMouseDown,players=1===e?[createPlayer(0,P1_KEYS,420,[80,180,255])]:[createPlayer(0,P1_KEYS,300,[80,180,255]),createPlayer(1,P2_KEYS,500,[255,180,80])],startLevel(1),gameState="playing"}function startLevel(e){"undefined"!=typeof gameSFX&&gameSFX.playNewLevel(),level=e,levelComplete=!1,infectionStarted=!1,currentMaxEnemies=1+level;for(let t of players)resetShip(t,getSpawnX(t)),t.homingMissiles=[],e>1?t.missilesRemaining++:t.missilesRemaining=1,t.dead=!1,t.respawnTimer=0;enemies=[],bombs=[],enemyBullets=[],activePulses=[];for(let e=0;e<currentMaxEnemies;e++)spawnEnemy(0===e);infectedTiles={}}function spawnEnemy(e=!1){let t="seeder";if(!e&&level>0){let e=random();e<.3?t="fighter":e<.5?t="bomber":e<.7?t="crab":e<.8?t="hunter":e<.9&&(t="squid")}let l=random(-4e3,4e3),i=random(-4e3,4e3),o=random(-300,-800);"crab"===t&&(o=getAltitude(l,i)-10),enemies.push({x:l,y:o,z:i,vx:random(-2,2),vz:random(-2,2),id:random(),type:t,fireTimer:0,bombTimer:0})}function drawMenu(){background(8,12,28),setup2DViewport(),noStroke();for(let e of menuStars){e.y+=.002*e.spd,e.y>1&&(e.y-=2);let t=e.x*width/2,l=e.y*height/2,i=150+105*sin(.05*frameCount+100*e.x);fill(i,i,i+30,i),ellipse(t,l,e.s,e.s)}let e=.3*sin(.04*frameCount)+.7;noStroke(),fill(0,255,60,18*e),ellipse(0,.14*-height,500*e,140*e),fill(0,255,60,10*e),ellipse(0,.14*-height,700*e,200*e),textAlign(CENTER,CENTER),noStroke(),fill(0,180,40,80),textSize(110),text("V I R O N",3,.14*-height+4);let t=30*sin(.06*frameCount);fill(30+t,255,60+t),textSize(110),text("V I R O N",0,.14*-height),textSize(16),fill(140,200,140,180),text("Christian Nold, 2026",0,.14*-height+70);for(let e=-height/2;e<height/2;e+=4)stroke(0,0,0,20),strokeWeight(1),line(-width/2,e,width/2,e);noStroke();let l=.08*height,i=.3*sin(.08*frameCount)+.7,o=.3*sin(.08*frameCount+1.5)+.7;textSize(28),isMobile?(fill(255,255,255,255*i),text("TAP TO START",0,l+25)):(fill(255,255,255,255*i),text("PRESS 1 — SINGLE PLAYER",0,l),fill(255,255,255,255*o),text("PRESS 2 — MULTIPLAYER",0,l+50)),textSize(13),fill(100,140,100,150),isMobile?text("Use virtual joystick and buttons to play",0,height/2-40):(text("P1: w/RMB thrust  Mouse pitch/yaw  Q/LMB shoot  E/MMB missile",0,height/2-55),text("P2: ARROWS + ;/' pitch  . shoot  / missile",0,height/2-35)),pop()}function drawGameOver(){setup2DViewport(),drawingContext.clear(drawingContext.DEPTH_BUFFER_BIT),fill(255,60,60),textAlign(CENTER,CENTER),textSize(80),text("GAME OVER",0,-50),textSize(24),fill(180,200,180),text(gameOverReason||"INFECTION REACHED CRITICAL MASS",0,40),pop(),millis()-levelEndTime>5e3&&(gameState="menu")}function renderPlayerView(e,t,l,i,o,r,n){let a=t.ship,s=i*n,p=o*n,f=r*n;e.viewport(s,0,p,f),e.enable(e.SCISSOR_TEST),e.scissor(s,0,p,f),e.clearColor(30/255,60/255,120/255,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),push(),perspective(PI/3,o/r,50,120*VIEW_FAR*1.5);let d=min(a.y-120,140),u=a.x+550*sin(a.yaw),m=d,h=a.z+550*cos(a.yaw);camera(u,m,h,a.x,a.y,a.z,0,1,0),"undefined"!=typeof gameSFX&&gameSFX.updateListener(u,m,h,a.x,a.y,a.z,0,1,0),setSceneLighting(),drawLandscape(a),drawTrees(a),drawBuildings(a),drawEnemies(a);for(let e of players)e.dead||shipDisplay(e.ship,e.labelColor),renderProjectiles(e,a.x,a.z);renderParticles(a.x,a.z),pop(),e.clear(e.DEPTH_BUFFER_BIT),drawPlayerHUD(t,l,o,r),isMobile&&1===numPlayers&&"undefined"!=typeof mobileController&&mobileController.draw(width,height),e.disable(e.SCISSOR_TEST)}function draw(){if("menu"===gameState)return void drawMenu();if("gameover"===gameState)return void drawGameOver();if(frameCount>60&&frameCount%120==0){let e=frameRate();window.maxObservedFPS||(window.maxObservedFPS=60),e>window.maxObservedFPS+2&&(window.maxObservedFPS=e);let t=window.maxObservedFPS>70?75:60;e<.9*t?(VIEW_NEAR=max(15,VIEW_NEAR-2),VIEW_FAR=max(20,VIEW_FAR-2),CULL_DIST=max(2e3,CULL_DIST-400)):e>=.95*t&&(VIEW_NEAR=min(35,VIEW_NEAR+1),VIEW_FAR=min(50,VIEW_FAR+1),CULL_DIST=min(6e3,CULL_DIST+200))}altCache.size>1e4&&altCache.clear(),chunkCache.size>200&&chunkCache.clear();let e=drawingContext;isMobile&&1===numPlayers&&"undefined"!=typeof mobileController&&mobileController.update(touches,width,height);for(let e of players)updateShipInput(e);updateEnemies();for(let e of players)checkCollisions(e);spreadInfection(),updateParticlePhysics();for(let e of players)updateProjectilePhysics(e);let t=height,l=pixelDensity();if(1===numPlayers)renderPlayerView(e,players[0],0,0,width,t,l);else{let i=floor(width/2);for(let o=0;o<2;o++)renderPlayerView(e,players[o],o,o*i,i,t,l)}setup2DViewport(),2===numPlayers&&(stroke(0,255,0,180),strokeWeight(2),line(0,-height/2,0,height/2)),levelComplete&&(noStroke(),fill(0,255,0),textAlign(CENTER,CENTER),textSize(40),text("LEVEL "+level+" COMPLETE",0,0)),pop();let i=Object.keys(infectedTiles).length;i>0&&(infectionStarted=!0),infectionStarted&&0===i&&!levelComplete&&(levelComplete=!0,levelEndTime=millis()),levelComplete&&millis()-levelEndTime>4e3&&startLevel(level+1);for(let e of players)e.dead&&(e.respawnTimer--,e.respawnTimer<=0&&(e.dead=!1,resetShip(e,getSpawnX(e))))}function spreadInfection(){if(frameCount%5!=0)return;let e=Object.keys(infectedTiles),t=e.length;if(t>=2e3)return void("gameover"!==gameState&&(gameState="gameover",gameOverReason="INFECTION REACHED CRITICAL MASS",levelEndTime=millis(),"undefined"!=typeof gameSFX&&gameSFX.playGameOver()));let l=0,i=0;for(let e=0;e<7;e++)for(let t=0;t<7;t++)i++,infectedTiles[tileKey(e,t)]&&l++;if(l>=i)return void("gameover"!==gameState&&(gameState="gameover",gameOverReason="LAUNCH PAD INFECTED",levelEndTime=millis(),"undefined"!=typeof gameSFX&&gameSFX.playGameOver()));let o=[];for(let l=0;l<t;l++){if(random()>.01)continue;let t=e[l].split(","),i=+t[0],r=+t[1],n=ORTHO_DIRS[floor(random(4))],a=i+n[0],s=r+n[1],p=tileKey(a,s);aboveSea(getAltitude(120*a,120*s))||infectedTiles[p]||o.push(p)}let r=o.length;for(let e=0;e<r;e++){let t=o[e];infectedTiles[t]={tick:frameCount};let l=t.split(","),i=+l[0],r=+l[1];"undefined"!=typeof gameSFX&&gameSFX.playInfectionSpread(120*i,getAltitude(120*i,120*r),120*r),isLaunchpad(120*i,120*r)&&millis()-lastAlarmTime>1e3&&("undefined"!=typeof gameSFX&&gameSFX.playAlarm(),lastAlarmTime=millis())}}function clearInfectionAt(e,t,l){let i=toTile(e),o=toTile(t);return!!infectedTiles[tileKey(i,o)]&&(clearInfectionRadius(i,o),l&&(l.score+=100),"undefined"!=typeof gameSFX&&gameSFX.playClearInfection(e,getAltitude(e,t),t),!0)}function updateShipInput(e){if(e.dead)return;0===e.id&&!isMobile&&document.pointerLockElement&&(smoothedMX=lerp(smoothedMX,movedX,.25),smoothedMY=lerp(smoothedMY,movedY,.25),e.ship.yaw-=.003*smoothedMX,e.ship.pitch=constrain(e.ship.pitch-.003*smoothedMY,-PI/2.2,PI/2.2));let t=e.keys;leftMouseDown||(mouseReleasedSinceStart=!0);let l=keyIsDown(t.thrust)||0===e.id&&!isMobile&&rightMouseDown,i=keyIsDown(t.brake),o=keyIsDown(t.shoot)||0===e.id&&!isMobile&&leftMouseDown&&mouseReleasedSinceStart;if(isMobile&&0===e.id&&"undefined"!=typeof mobileController){let t=mobileController.getInputs(e.ship,enemies,.04,.04);l=l||t.thrust,o=o||t.shoot,t.missile&&!e.mobileMissilePressed?(fireMissile(e),e.mobileMissilePressed=!0):t.missile||(e.mobileMissilePressed=!1),e.ship.yaw+=t.yawDelta,e.ship.pitch=constrain(e.ship.pitch+t.pitchDelta,-PI/2.2,PI/2.2)}keyIsDown(t.left)&&(e.ship.yaw+=.04),keyIsDown(t.right)&&(e.ship.yaw-=.04),keyIsDown(t.pitchUp)&&(e.ship.pitch=constrain(e.ship.pitch+.04,-PI/2.2,PI/2.2)),keyIsDown(t.pitchDown)&&(e.ship.pitch=constrain(e.ship.pitch-.04,-PI/2.2,PI/2.2));let r=e.ship;if(r.vy+=.09,l){let e=.45,t=shipUpDir(r);r.vx+=t.x*e,r.vy+=t.y*e,r.vz+=t.z*e,frameCount%2==0&&particles.push({x:r.x,y:r.y,z:r.z,vx:8*-t.x+random(-1,1),vy:8*-t.y+random(-1,1),vz:8*-t.z+random(-1,1),life:255,decay:10,seed:random(1),size:random(2,6),color:[180,140,100]})}i&&(r.vx*=.96,r.vy*=.96,r.vz*=.96),o&&frameCount%6==0&&(e.bullets.push(spawnProjectile(r,25,300)),"undefined"!=typeof gameSFX&&gameSFX.playShot(r.x,r.y,r.z)),r.vx*=.985,r.vy*=.985,r.vz*=.985,r.x+=r.vx,r.y+=r.vy,r.z+=r.vz;let n=getAltitude(r.x,r.z);if(r.y>188)return explosion(r.x,200,r.z),void killPlayer(e);r.y>n-12&&(r.vy>2.8?killPlayer(e):(r.y=n-12,r.vy=0,r.vx*=.8,r.vz*=.8))}function killPlayer(e){explosion(e.ship.x,e.ship.y,e.ship.z),addPulse(e.ship.x,e.ship.z,2),e.dead=!0,e.respawnTimer=120,e.bullets=[]}function checkCollisions(e){if(e.dead)return;let t=e.ship;for(let l=enemyBullets.length-1;l>=0;l--){let i=enemyBullets[l];if((i.x-t.x)**2+(i.y-t.y)**2+(i.z-t.z)**2<4900)return explosion(t.x,t.y,t.z),killPlayer(e),void enemyBullets.splice(l,1)}for(let l=enemies.length-1;l>=0;l--){let i=enemies[l],o=!1;for(let t=e.bullets.length-1;t>=0;t--){let r=e.bullets[t];if((r.x-i.x)**2+(r.y-i.y)**2+(r.z-i.z)**2<6400){explosion(i.x,i.y,i.z,getEnemyColor(i.type),i.type),enemies.splice(l,1),e.bullets.splice(t,1),e.score+=100,o=!0;break}}if(!o)for(let t=e.homingMissiles.length-1;t>=0;t--){let r=e.homingMissiles[t];if((r.x-i.x)**2+(r.y-i.y)**2+(r.z-i.z)**2<1e4){explosion(i.x,i.y,i.z,getEnemyColor(i.type),i.type),enemies.splice(l,1),e.homingMissiles.splice(t,1),e.score+=250,o=!0;break}}if(!o&&(t.x-i.x)**2+(t.y-i.y)**2+(t.z-i.z)**2<4900)return void killPlayer(e)}for(let l=buildings.length-1;l>=0;l--){let i=buildings[l];if(3===i.type){let o=getAltitude(i.x,i.z)-i.h-100-50*sin(.02*frameCount+i.x),r=t.x-i.x,n=t.y-o,a=t.z-i.z;if(r*r+n*n+a*a<(i.w+15)**2){let t=!!infectedTiles[tileKey(toTile(i.x),toTile(i.z))];t?(e.missilesRemaining>0&&e.missilesRemaining--,"undefined"!=typeof gameSFX&&gameSFX.playPowerup(!1,i.x,o,i.z)):(e.missilesRemaining++,e.score+=500,"undefined"!=typeof gameSFX&&gameSFX.playPowerup(!0,i.x,o,i.z)),buildings.splice(l,1);for(let e=0;e<20;e++)particles.push({x:i.x,y:o,z:i.z,vx:random(-4,4),vy:random(-4,4),vz:random(-4,4),life:255,decay:12,size:random(4,9),color:t?[200,50,50]:[60,180,240]})}}}for(let t=e.bullets.length-1;t>=0;t--){let l=e.bullets[t];for(let i of trees){let o=getAltitude(i.x,i.z);if((l.x-i.x)**2+(l.z-i.z)**2<3600&&l.y>o-i.trunkH-30*i.canopyScale-10&&l.y<o+10){let l=toTile(i.x),o=toTile(i.z);if(infectedTiles[tileKey(l,o)]){clearInfectionRadius(l,o),e.score+=200,e.bullets.splice(t,1);break}}}}}function updateParticlePhysics(){for(let e=particles.length-1;e>=0;e--){let t=particles[e];if(t.x+=t.vx,t.y+=t.vy,t.z+=t.vz,t.life-=t.decay||10,t.vx*=.98,t.vy*=.98,t.vz*=.98,t.life<=0){let t=particles.pop();e<particles.length&&(particles[e]=t)}}for(let e=bombs.length-1;e>=0;e--){let t=bombs[e];t.y+=8;let l=getAltitude(t.x,t.z);if(t.y>l){if("mega"===t.type){let e=toTile(t.x),l=toTile(t.z),i=!1;for(let t=-4;t<=4;t++)for(let o=-4;o<=4;o++)if(t*t+o*o<=16){let r=e+t,n=l+o;if(aboveSea(getAltitude(120*r,120*n)))continue;let a=tileKey(r,n);infectedTiles[a]||(infectedTiles[a]={tick:frameCount},isLaunchpad(120*r,120*n)&&(i=!0))}i&&millis()-lastAlarmTime>1e3&&("undefined"!=typeof gameSFX&&gameSFX.playAlarm(),lastAlarmTime=millis())}else infectedTiles[t.k]||(infectedTiles[t.k]={tick:frameCount},isLaunchpad(t.x,t.z)&&millis()-lastAlarmTime>1e3&&("undefined"!=typeof gameSFX&&gameSFX.playAlarm(),lastAlarmTime=millis()));addPulse(t.x,t.z,0),"undefined"!=typeof gameSFX&&gameSFX.playExplosion("mega"===t.type,"mega"===t.type?"bomber":"normal",t.x,t.y,t.z),bombs.splice(e,1)}}for(let e=enemyBullets.length-1;e>=0;e--){let t=enemyBullets[e];t.x+=t.vx,t.y+=t.vy,t.z+=t.vz,t.life-=2,(t.life<=0||t.y>getAltitude(t.x,t.z)||t.y>200)&&enemyBullets.splice(e,1)}}function updateProjectilePhysics(e){for(let t=e.bullets.length-1;t>=0;t--){let l=e.bullets[t];l.x+=l.vx,l.y+=l.vy,l.z+=l.vz,l.life-=2,l.life<=0?e.bullets.splice(t,1):l.y>getAltitude(l.x,l.z)&&(clearInfectionAt(l.x,l.z,e),e.bullets.splice(t,1))}for(let t=e.homingMissiles.length-1;t>=0;t--){let l=e.homingMissiles[t];const i=10;let o=findNearest(enemies,l.x,l.y,l.z);if(o){let e=o.x-l.x,t=o.y-l.y,r=o.z-l.z,n=Math.hypot(e,t,r);if(n>0){let o=.12;l.vx=lerp(l.vx,e/n*i,o),l.vy=lerp(l.vy,t/n*i,o),l.vz=lerp(l.vz,r/n*i,o)}}let r=Math.hypot(l.vx,l.vy,l.vz);r>0&&(l.vx=l.vx/r*i,l.vy=l.vy/r*i,l.vz=l.vz/r*i),l.x+=l.vx,l.y+=l.vy,l.z+=l.vz,l.life--,frameCount%2==0&&particles.push({x:l.x,y:l.y,z:l.z,vx:random(-.5,.5),vy:random(-.5,.5),vz:random(-.5,.5),life:120,decay:5,seed:random(1),size:random(2,5)});let n=getAltitude(l.x,l.z);(l.life<=0||l.y>n)&&(l.y>n&&(explosion(l.x,l.y,l.z),clearInfectionAt(l.x,l.z,e)),e.homingMissiles.splice(t,1))}}function renderParticles(e,t){let l=.6*CULL_DIST*(.6*CULL_DIST);if(particles.length>0){noStroke();for(let i of particles){if((i.x-e)**2+(i.z-t)**2>l)continue;let o,r,n,a=i.seed||1,s=i.life/255,p=1-s,f=(5+6*a)%6,d=(3+6*a)%6,u=(1+6*a)%6,m=255*(1-Math.max(Math.min(f,4-f,1),0)),h=255*(1-Math.max(Math.min(d,4-d,1),0)),c=255*(1-Math.max(Math.min(u,4-u,1),0)),x=s<.4?s/.4*255:255;if(i.isFog&&(x*=.9),i.isExplosion){let e=Math.hypot(i.x-i.cx,i.y-i.cy,i.z-i.cz),t=1400*Math.pow(p,.6)-e;if(t<-50)x=0,o=0,r=0,n=0;else if(t<40){let e=(t+50)/90;o=lerp(255,i.br,e),r=lerp(255,i.bg,e),n=lerp(255,i.bb,e)}else if(t<150){let e=(t-40)/110;o=lerp(i.br,i.er,e),r=lerp(i.bg,i.eg,e),n=lerp(i.bb,i.eb,e)}else if(t<350){let e=(t-150)/200;o=lerp(i.er,i.sr,e),r=lerp(i.eg,i.sg,e),n=lerp(i.eb,i.sb,e)}else o=i.sr,r=i.sg,n=i.sb}else if(i.color){let e=Math.min(1.5*p,1);o=lerp(i.color[0],30,e),r=lerp(i.color[1],30,e),n=lerp(i.color[2],30,e)}else if(p<.15){let e=p/.15;o=lerp(255,m,e),r=lerp(255,h,e),n=lerp(255,c,e)}else if(p<.6){let e=(p-.15)/.45;o=lerp(m,.4*m,e),r=lerp(h,.4*h,e),n=lerp(c,.4*c,e)}else{let e=(p-.6)/.4;o=lerp(.4*m,15,e),r=lerp(.4*h,15,e),n=lerp(.4*c,15,e)}push(),translate(i.x,i.y,i.z),fill(o,r,n,x),box(i.size||8),pop()}}for(let e of bombs)push(),translate(e.x,e.y,e.z),noStroke(),fill(200,50,50),box(8,20,8),pop();for(let e of enemyBullets)push(),translate(e.x,e.y,e.z),noStroke(),fill(255,80,80),box(6),pop()}function renderProjectiles(e,t,l){let i=.8*CULL_DIST*(.8*CULL_DIST);for(let o of e.bullets)(o.x-t)**2+(o.z-l)**2>i||(push(),translate(o.x,o.y,o.z),noStroke(),fill(e.labelColor[0],e.labelColor[1],e.labelColor[2]),box(6),pop());for(let o of e.homingMissiles)(o.x-t)**2+(o.z-l)**2>i||(push(),translate(o.x,o.y,o.z),noStroke(),fill(0,200,255),box(10),pop())}function drawPlayerHUD(e,t,l,i){let o=e.ship;push(),ortho(-l/2,l/2,-i/2,i/2,0,1e3),resetMatrix(),noStroke(),textAlign(LEFT,TOP);let r=-l/2+14,n=-i/2,a=e.labelColor;textSize(16),fill(a[0],a[1],a[2]),text("P"+(t+1),r,n+6);let s=[[20,[255,255,255],"SCORE "+e.score,r,n+26],[16,[0,255,0],"ALT "+max(0,floor(200-o.y)),r,n+50],[14,[255,80,80],"INF "+Object.keys(infectedTiles).length,r,n+72],[14,[255,100,100],"ENEMIES "+enemies.length,r,n+90],[14,[0,200,255],"MISSILES "+e.missilesRemaining,r,n+108]];for(let[e,t,l,i,o]of s)textSize(e),fill(t[0],t[1],t[2]),text(l,i,o);textSize(16),fill(255),textAlign(RIGHT,TOP),text("LVL "+level,l/2-14,n+6),e.dead&&(fill(255,0,0,200),textAlign(CENTER,CENTER),textSize(28),text("DESTROYED",0,0),textSize(16),fill(200),text("Respawning...",0,30)),drawRadarForPlayer(e,l,i),drawControlHints(e,t,l,i),pop()}function drawRadarForPlayer(e,t,l){let i=e.ship;push(),translate(t/2-70,-l/2+80,0),fill(0,150),stroke(0,255,0),strokeWeight(1.5),rectMode(CENTER),rect(0,0,110,110),rotateZ(i.yaw),fill(180,0,0,80),noStroke();for(let e of Object.keys(infectedTiles)){let[t,l]=e.split(",").map(Number),o=.012*(120*t-i.x),r=.012*(120*l-i.z);abs(o)<50&&abs(r)<50&&rect(o,r,2,2)}let o=.012*(420-i.x),r=.012*(420-i.z);abs(o)<50&&abs(r)<50&&(fill(255,255,0,150),noStroke(),rect(o,r,4,4)),fill(255,0,0),noStroke();for(let e of enemies){let t=.012*(e.x-i.x),l=.012*(e.z-i.z);abs(t)<50&&abs(l)<50?rect(t,l,3,3):(push(),translate(constrain(t,-49,49),constrain(l,-49,49),0),rotateZ(atan2(l,t)),fill(255,0,0,180),triangle(3,0,-2,-2,-2,2),pop())}let n=players[1-e.id];if(n&&!n.dead){let e=.012*(n.ship.x-i.x),t=.012*(n.ship.z-i.z);fill(n.labelColor[0],n.labelColor[1],n.labelColor[2],200),noStroke(),abs(e)<50&&abs(t)<50&&rect(e,t,4,4)}rotateZ(-i.yaw),fill(255,255,0),rect(0,0,4,4),pop()}function drawControlHints(e,t,l,i){if(isMobile)return;push(),textAlign(CENTER,BOTTOM),textSize(11),fill(255,255,255,120);let o="";o=1===numPlayers?"W/RMB thrust  Mouse pitch/yaw  Q/LMB shoot  E/MMB missile  S brake  (Click to lock mouse)":0===t?"W/RMB thrust  Mouse pitch/yaw  Q/LMB shoot  E/MMB missile  S brake  (Click lock)":"↑ thrust  ←/→ turn  ;/' pitch  . shoot  / missile  ↓ brake",text(o,0,i/2-8),pop()}function getGridAltitude(e,t){let l=tileKey(e,t),i=altCache.get(l);if(void 0!==i)return i;let o,r=120*e,n=120*t;if(isLaunchpad(r,n))o=100;else{let e=8e-4*r,t=8e-4*n,l=noise(e,t)+.5*noise(2.5*e,2.5*t)+.25*noise(5*e,5*t);o=300-550*Math.pow(l/1.75,2)}return altCache.set(l,o),o}function getAltitude(e,t){if(isLaunchpad(e,t))return 100;let l=Math.floor(e/120),i=Math.floor(t/120),o=(e-120*l)/120,r=(t-120*i)/120;if(0===o&&0===r)return getGridAltitude(l,i);let n=getGridAltitude(l,i),a=getGridAltitude(l+1,i),s=getGridAltitude(l,i+1),p=getGridAltitude(l+1,i+1);return o+r<=1?n+(a-n)*o+(s-n)*r:p+(s-p)*(1-o)+(a-p)*(1-r)}function getChunkGeometry(e,t){let l=e+","+t,i=chunkCache.get(l);if(void 0!==i)return i;let o=buildGeometry(()=>{let l=16*e,i=16*t;beginShape(TRIANGLES);for(let e=i;e<i+16;e++)for(let t=l;t<l+16;t++){let l=120*t,i=120*e,o=l+120,r=i+120,n=getAltitude(l,i),a=getAltitude(o,i),s=getAltitude(l,r),p=getAltitude(o,r),f=.25*(n+a+s+p),d=Math.min(n,a,s,p);if(aboveSea(d))continue;let u,m,h,c=(t+e)%2==0;if(isLaunchpad(l,i)||isLaunchpad(o,i)||isLaunchpad(l,r)||isLaunchpad(o,r))u=255,m=255,h=255;else{let l=43758.5453*Math.abs(Math.sin(12.9898*t+78.233*e))%1;if(f>185){let e=[[230,210,80],[200,180,60],[150,180,50]][Math.floor(3*l)];u=e[0],m=e[1],h=e[2]}else{let i=[[60,180,60],[30,120,40],[180,200,50],[220,200,80],[210,130,140],[180,140,70]],o=noise(.15*t,.15*e),r=i[Math.floor(6*(2*o+.2*l))%6];u=r[0],m=r[1],h=r[2]}}fill(c?u:.85*u,c?m:.85*m,c?h:.85*h),vertex(l,n,i),vertex(o,a,i),vertex(l,s,r),vertex(o,a,i),vertex(o,p,r),vertex(l,s,r)}endShape()});return chunkCache.set(l,o),o}function getFogColor(e,t){let l=constrain(map(t,120*VIEW_FAR-800,120*VIEW_FAR+400,0,1),0,1);return[lerp(e[0],30,l),lerp(e[1],60,l),lerp(e[2],120,l)]}function applyTerrainShader(){shader(terrainShader),terrainShader.setUniform("uTime",millis()/1e3),terrainShader.setUniform("uFogDist",[120*VIEW_FAR-800,120*VIEW_FAR+400]);let e=[];for(let t=0;t<5;t++)t<activePulses.length?e.push(activePulses[t].x,activePulses[t].z,activePulses[t].start,activePulses[t].type||0):e.push(0,0,-9999,0);terrainShader.setUniform("uPulses",e)}function drawLandscape(e){let t=toTile(e.x),l=toTile(e.z);noStroke();let i=[],o=getCameraParams(e);noLights(),applyTerrainShader();let r=Math.floor((t-VIEW_FAR)/16),n=Math.floor((t+VIEW_FAR)/16),a=Math.floor((l-VIEW_FAR)/16),s=Math.floor((l+VIEW_FAR)/16);for(let e=a;e<=s;e++)for(let t=r;t<=n;t++){let l=16*(e+.5)*120,r=16*(t+.5)*120-o.x,n=l-o.z;if(r*o.fwdX+n*o.fwdZ<-2880)continue;let a=getChunkGeometry(t,e);model(a);for(let l=16*t;l<16*(t+1);l++)for(let t=16*e;t<16*(e+1);t++)if(infectedTiles[tileKey(l,t)]){let e=120*l,r=120*t,n=e+60,a=r+60,s=(o.x-n)*(o.x-n)+(o.z-a)*(o.z-a),p=(Math.sqrt(s),e+120),f=r+120,d=getAltitude(e,r)-.5,u=getAltitude(p,r)-.5,m=getAltitude(e,f)-.5,h=getAltitude(p,f)-.5,c=.25*(getAltitude(e,r)+getAltitude(p,r)+getAltitude(e,f)+getAltitude(p,f)),x=[e,d,r,p,u,r,e,m,f,p,u,r,p,h,f,e,m,f],y=(l+t)%2==0,v=.5*sin(.08*frameCount+.5*l+.3*t)+.5,g=map(c,-100,200,1.15,.65),S=y?[160,255,10,40,10,25]:[120,200,5,25,5,15],z=lerp(S[0],S[1],v)*g,b=lerp(S[2],S[3],v)*g,w=lerp(S[4],S[5],v)*g;i.push({v:x,r:z,g:b,b:w})}}if(i.length){beginShape(TRIANGLES);for(let e of i){fill(e.r,e.g,e.b);let t=e.v;vertex(t[0],t[1],t[2]),vertex(t[3],t[4],t[5]),vertex(t[6],t[7],t[8]),vertex(t[9],t[10],t[11]),vertex(t[12],t[13],t[14]),vertex(t[15],t[16],t[17])}endShape()}let p=8*sin(.03*frameCount),f=getSeaGeometry(120*VIEW_FAR*1.5,[15,45+p,150+p],e.x,e.z);model(f),resetShader(),setSceneLighting(),push();for(let e=200;e<=640;e+=120){let t=(740-o.x)*o.fwdX+(e-o.z)*o.fwdZ,l=getFogColor([60,60,60],t),i=getFogColor([255,140,20],t);push(),translate(740,100,e),fill(l[0],l[1],l[2]),push(),translate(0,-10,0),box(30,20,30),pop(),fill(i[0],i[1],i[2]),push(),translate(0,-70,0),rotateX(Math.PI),cone(18,100,4,1),pop(),pop()}pop()}function getSeaGeometry(e,t,l,i){return buildGeometry(()=>{fill(t[0],t[1],t[2]),beginShape(TRIANGLES);let o=203,r=120*toTile(l),n=120*toTile(i);vertex(r-e,o,n-e),vertex(r+e,o,n-e),vertex(r-e,o,n+e),vertex(r+e,o,n-e),vertex(r+e,o,n+e),vertex(r-e,o,n+e),endShape()})}function drawTrees(e){let t=120*VIEW_FAR,l=t*t,i=getCameraParams(e);for(let t of trees){let o=(e.x-t.x)**2+(e.z-t.z)**2;if(o>=l||!inFrustum(i,t.x,t.z))continue;let r=getAltitude(t.x,t.z);if(aboveSea(r)||isLaunchpad(t.x,t.z))continue;push(),translate(t.x,r,t.z),noStroke();let{trunkH:n,canopyScale:a,variant:s}=t,p=!!infectedTiles[tileKey(toTile(t.x),toTile(t.z))],f=(t.x-i.x)*i.fwdX+(t.z-i.z)*i.fwdZ,d=getFogColor([p?80:100,p?40:65,p?20:25],f);fill(d[0],d[1],d[2]),push(),translate(0,-n/2,0),box(5,n,5),pop();let u=TREE_VARIANTS[s],m=getFogColor(p?u.infected:u.healthy,f);if(fill(m[0],m[1],m[2]),2===s)push(),translate(0,-n,0),cone(35*a,15*a,6,1),pop();else{let e=u.cones[0];if(push(),translate(0,-n-e[2]*a,0),cone(e[0]*a,e[1]*a,4,1),pop(),u.cones2){let e=getFogColor(p?u.infected2:u.healthy2,f);fill(e[0],e[1],e[2]);let t=u.cones2[0];push(),translate(0,-n-t[2]*a,0),cone(t[0]*a,t[1]*a,4,1),pop()}}o<225e4&&(push(),translate(0,-.5,8),rotateX(PI/2),fill(0,0,0,40),ellipse(0,0,20*a,12*a),pop()),pop()}}function drawBuildings(e){let t=120*VIEW_FAR*VIEW_FAR*120,l=getCameraParams(e);for(let i of buildings){let o=(e.x-i.x)**2+(e.z-i.z)**2;if(o>=t||!inFrustum(l,i.x,i.z))continue;let r=getAltitude(i.x,i.z);if(aboveSea(r)||isLaunchpad(i.x,i.z))continue;let n=!!infectedTiles[tileKey(toTile(i.x),toTile(i.z))],a=(i.x-l.x)*l.fwdX+(i.z-l.z)*l.fwdZ;if(push(),translate(i.x,r,i.z),noStroke(),0===i.type){let e=getFogColor(n?[200,50,50]:[220,220,220],a);fill(e[0],e[1],e[2]),push(),translate(0,-i.h/2,0),box(i.w,i.h,i.d),pop();let t=getFogColor(n?[150,30,30]:[220,50,50],a);fill(t[0],t[1],t[2]),push(),translate(0,-i.h-i.w/3,0),rotateY(PI/4),cone(.8*i.w,i.w/1.5,4,1),pop()}else if(1===i.type){let e=getFogColor(n?[200,50,50]:[150,160,170],a);fill(e[0],e[1],e[2]),push(),translate(0,-i.h/2,0),cylinder(i.w/2,i.h,8,1),pop();let t=getFogColor(n?[150,30,30]:[80,180,220],a);fill(t[0],t[1],t[2]),push(),translate(0,-i.h,0),sphere(i.w/2,8,8),pop()}else if(2===i.type){let e=getFogColor(n?[200,50,50]:i.col,a);fill(e[0],e[1],e[2]),push(),translate(0,-i.h/4,0),box(1.5*i.w,i.h/2,1.5*i.d),pop(),push(),translate(.3*i.w,-i.h/2-i.h/8,.2*-i.d),box(i.w/2,i.h/4,i.d/2),pop();let t=getFogColor(n?[120,20,20]:[80,80,80],a);fill(t[0],t[1],t[2]),push(),translate(.4*-i.w,-i.h,.4*i.d),cylinder(.15*i.w,i.h,8,1),pop()}else{let e=getFogColor(n?[200,50,50]:[60,180,240],a);fill(e[0],e[1],e[2]),push();let t=r-i.h-100-50*sin(.02*frameCount+i.x);translate(0,t-r,0),rotateY(.01*frameCount+i.x),rotateZ(.015*frameCount+i.z),cone(i.w,i.h/2,4,1),rotateX(PI),cone(i.w,i.h/2,4,1),pop()}pop(),o<225e4&&drawShadow(i.x,r,i.z,1.5*i.w,1.5*i.d)}}function shipDisplay(e,t){applyTerrainShader(),noStroke();let l=Math.cos(e.yaw),i=Math.sin(e.yaw),o=Math.cos(e.pitch),r=Math.sin(e.pitch),n=t=>{let n=t[0],a=t[1],s=t[2],p=a*o-s*r,f=a*r+s*o,d=-n*i+f*l;return[n*l+f*i+e.x,p+e.y,d+e.z]},a=t[0],s=t[1],p=t[2],f=[[lerp(200,a,.3),lerp(200,s,.3),lerp(200,p,.3),[-15,10,15],[15,10,15],[0,10,-25]],[lerp(170,a,.2),lerp(170,s,.2),lerp(170,p,.2),[0,-10,5],[-15,10,15],[0,10,-25]],[lerp(150,a,.2),lerp(150,s,.2),lerp(150,p,.2),[0,-10,5],[15,10,15],[0,10,-25]],[lerp(130,a,.15),lerp(130,s,.15),lerp(130,p,.15),[0,-10,5],[-15,10,15],[15,10,15]]];for(let[e,t,l,i,o,r]of f)fill(e,t,l),beginShape(),vertex(...n(i)),vertex(...n(o)),vertex(...n(r)),endShape(CLOSE);resetShader(),setSceneLighting();let d=getAltitude(e.x,e.z);drawShipShadow(e.x,d,e.z,e.yaw,e.y)}function drawEnemies(e){let t=getCameraParams(e),l=CULL_DIST*CULL_DIST;for(let i of enemies){if((i.x-e.x)**2+(i.z-e.z)**2>l)continue;let o=(i.x-t.x)*t.fwdX+(i.z-t.z)*t.fwdZ;if(push(),translate(i.x,i.y,i.z),"crab"===i.type&&translate(0,-10,0),scale(2),"fighter"===i.type){let e=i.vx||.1,t=i.vy||0,l=i.vz||.1,r=Math.hypot(e,t,l);if(r>0){let i=atan2(e,l);rotateY(i);let o=asin(t/r);rotateX(-o)}noStroke();let n=getFogColor([255,150,0],o);fill(n[0],n[1],n[2]),beginShape(TRIANGLES),vertex(0,0,20),vertex(-15,0,-15),vertex(15,0,-15),vertex(0,0,20),vertex(-15,0,-15),vertex(0,-10,0),vertex(0,0,20),vertex(15,0,-15),vertex(0,-10,0),vertex(0,0,20),vertex(-15,0,-15),vertex(0,10,0),vertex(0,0,20),vertex(15,0,-15),vertex(0,10,0),endShape()}else if("bomber"===i.type){rotateY(.05*frameCount),noStroke();let e=getFogColor([180,20,180],o);fill(e[0],e[1],e[2]),beginShape(TRIANGLES),vertex(0,-40,0),vertex(-40,0,-40),vertex(40,0,-40),vertex(0,-40,0),vertex(-40,0,40),vertex(40,0,40),vertex(0,-40,0),vertex(-40,0,-40),vertex(-40,0,40),vertex(0,-40,0),vertex(40,0,-40),vertex(40,0,40),vertex(0,40,0),vertex(-40,0,-40),vertex(40,0,-40),vertex(0,40,0),vertex(-40,0,40),vertex(40,0,40),vertex(0,40,0),vertex(-40,0,-40),vertex(-40,0,40),vertex(0,40,0),vertex(40,0,-40),vertex(40,0,40),endShape()}else if("crab"===i.type){let e=atan2(i.vx||0,i.vz||0);rotateY(e),noStroke();let t=getFogColor([200,80,20],o),l=getFogColor([150,40,10],o);fill(t[0],t[1],t[2]),push(),box(36,16,30),pop(),push(),translate(0,-8,0),box(24,8,20),pop(),push(),fill(10,10,10),translate(-8,-10,15),box(4,8,4),translate(16,0,0),box(4,8,4),pop(),fill(l[0],l[1],l[2]);let r=.3*frameCount+i.id;for(let e=-1;e<=1;e+=2)for(let t=-1;t<=1;t++){let l=r+t*PI/3*e,i=max(0,sin(l)),o=cos(l);push(),translate(16*e,0,10*t),rotateZ(e*(-.2-.4*i)),rotateY(.3*o),translate(10*e,-3,0),box(20,6,6),translate(8*e,0,0),rotateZ(.8*e),translate(10*e,0,0),box(22,4,4),pop()}fill(t[0],t[1],t[2]);for(let e=-1;e<=1;e+=2){let t=.1*sin(.1*frameCount+i.id);push(),translate(16*e,0,14),rotateY(-.6*e),rotateZ(e*(-.3+t)),translate(10*e,0,0),box(20,6,8),translate(10*e,0,0),rotateY(-1.2*e),translate(8*e,0,0),box(16,8,10),translate(10*e,0,0),box(12,10,12);let l=.5*abs(sin(.2*frameCount+3*i.id));push(),translate(6*e,0,-4),rotateY(e*-l),translate(8*e,0,0),box(16,5,4),pop(),push(),translate(6*e,0,4),rotateY(e*l),translate(8*e,0,0),box(16,5,4),pop(),pop()}}else if("hunter"===i.type){let e=i.vx||.1,t=i.vy||0,l=i.vz||.1,r=Math.hypot(e,t,l);r>0&&(rotateY(atan2(e,l)),rotateX(-asin(t/r))),noStroke();let n=getFogColor([40,255,40],o);fill(n[0],n[1],n[2]),beginShape(TRIANGLES),vertex(0,0,30),vertex(-8,0,-20),vertex(8,0,-20),vertex(0,0,30),vertex(-8,0,-20),vertex(0,-10,0),vertex(0,0,30),vertex(8,0,-20),vertex(0,-10,0),endShape()}else if("squid"===i.type){let e=i.vx||.1,t=i.vy||0,l=i.vz||.1,r=Math.hypot(e,t,l);r>0&&(rotateY(atan2(e,l)),rotateX(-asin(t/r))),noStroke();let n=getFogColor([30,30,35],o);fill(n[0],n[1],n[2]),push(),rotateX(PI/2),cylinder(12,40,8,1);let a=.1*frameCount+i.id;for(let e=0;e<8;e++){push();let t=e/8*TWO_PI;translate(8*sin(t),20,8*cos(t)),rotateX(.4*sin(a+t)),rotateZ(.4*cos(a+t)),translate(0,15,0),cylinder(2,30,4,1),pop()}pop()}else{rotateY(.15*frameCount),noStroke();for(let[e,t]of[[-10,[220,30,30]],[6,[170,15,15]]]){let l=getFogColor(t,o);fill(l[0],l[1],l[2]),beginShape(TRIANGLES),vertex(0,e,-25),vertex(-22,0,0),vertex(22,0,0),vertex(0,e,25),vertex(-22,0,0),vertex(22,0,0),vertex(0,e,-25),vertex(-22,0,0),vertex(0,e,25),vertex(0,e,-25),vertex(22,0,0),vertex(0,e,25),endShape()}let e=getFogColor([255,60,60],o);fill(e[0],e[1],e[2]),push(),translate(0,-14,0),box(3,14,3),pop()}pop();let r="bomber"===i.type?60:"fighter"===i.type||"hunter"===i.type?25:40;drawShadow(i.x,getAltitude(i.x,i.z),i.z,2*r,2*r)}}function updateEnemies(){let e=players.filter(e=>!e.dead).map(e=>e.ship),t=e[0]||players[0].ship;for(let l of enemies)"fighter"===l.type?updateFighter(l,e,t):"bomber"===l.type?updateBomber(l,t):"crab"===l.type?updateCrab(l,e,t):"hunter"===l.type?updateHunter(l,e,t):"squid"===l.type?updateSquid(l,e,t):updateSeeder(l,t)}function updateBomber(e,t){if(e.x+=1.5*e.vx,e.z+=1.5*e.vz,e.y+=sin(.02*frameCount+e.id),abs(e.x-t.x)>4e3&&(e.vx*=-1),abs(e.z-t.z)>4e3&&(e.vz*=-1),e.bombTimer++,e.bombTimer>600){e.bombTimer=0;let t=getAltitude(e.x,e.z);if(!aboveSea(t)){let t=toTile(e.x),l=toTile(e.z);bombs.push({x:e.x,y:e.y,z:e.z,k:tileKey(t,l),type:"mega"}),"undefined"!=typeof gameSFX&&gameSFX.playBombDrop("mega",e.x,e.y,e.z)}}}function updateCrab(e,t,l){let i=findNearest(t,e.x,e.y,e.z)||l,o=i.x-e.x,r=i.z-e.z,n=Math.hypot(o,r);n>0&&(e.vx=lerp(e.vx||0,o/n*1.2,.05),e.vz=lerp(e.vz||0,r/n*1.2,.05)),e.x+=e.vx,e.z+=e.vz;let a=getAltitude(e.x,e.z);if(e.y=a-10,e.fireTimer++,n<1500&&e.fireTimer>180&&(e.fireTimer=0,enemyBullets.push({x:e.x,y:e.y-10,z:e.z,vx:0,vy:-12,vz:0,life:100}),"undefined"!=typeof gameSFX&&gameSFX.playEnemyShot("crab",e.x,e.y-10,e.z)),random()<.02&&!aboveSea(a)){let t=toTile(e.x),l=toTile(e.z),i=tileKey(t,l);infectedTiles[i]||(infectedTiles[i]={tick:frameCount},isLaunchpad(e.x,e.z)&&millis()-lastAlarmTime>1e3&&("undefined"!=typeof gameSFX&&gameSFX.playAlarm(),lastAlarmTime=millis()),addPulse(e.x,e.z,1))}}function updateHunter(e,t,l){let i=findNearest(t,e.x,e.y,e.z)||l,o=i.x-e.x,r=i.y-e.y,n=i.z-e.z,a=Math.hypot(o,r,n);a>0&&(e.vx=lerp(e.vx||0,o/a*5,.1),e.vy=lerp(e.vy||0,r/a*5,.1),e.vz=lerp(e.vz||0,n/a*5,.1));let s=getAltitude(e.x,e.z);e.y>s-50&&(e.vy-=1),e.x+=e.vx,e.y+=e.vy,e.z+=e.vz}function updateFighter(e,t,l){let i=findNearest(t,e.x,e.y,e.z)||l;e.stateTimer=(e.stateTimer||0)+1,e.stateTimer>120&&(e.stateTimer=0,e.aggressive=random()>.5,e.aggressive||(e.wanderX=e.x+random(-1500,1500),e.wanderZ=e.z+random(-1500,1500)));let o=e.aggressive?i.x:e.wanderX||e.x,r=e.aggressive?i.z:e.wanderZ||e.z,n=e.aggressive?i.y:-600,a=o-e.x,s=n-e.y,p=r-e.z,f=Math.hypot(a,s,p);f>0&&(e.vx=lerp(e.vx||0,a/f*2.5,.05),e.vy=lerp(e.vy||0,s/f*2.5,.05),e.vz=lerp(e.vz||0,p/f*2.5,.05));let d=getAltitude(e.x,e.z);if(e.y>d-150&&(e.vy-=.5),e.x+=e.vx,e.y+=e.vy,e.z+=e.vz,e.fireTimer++,e.aggressive&&f<1200&&e.fireTimer>90){e.fireTimer=0;let t=a/f+random(-.2,.2),l=s/f+random(-.2,.2),i=p/f+random(-.2,.2),o=Math.hypot(t,l,i);enemyBullets.push({x:e.x,y:e.y,z:e.z,vx:t/o*10,vy:l/o*10,vz:i/o*10,life:120}),"undefined"!=typeof gameSFX&&gameSFX.playEnemyShot("fighter",e.x,e.y,e.z)}}function updateSeeder(e,t){if(e.x+=e.vx,e.z+=e.vz,e.y+=2*sin(.05*frameCount+e.id),abs(e.x-t.x)>5e3&&(e.vx*=-1),abs(e.z-t.z)>5e3&&(e.vz*=-1),random()<.008){let t=getAltitude(e.x,e.z);if(!aboveSea(t)){let t=toTile(e.x),l=toTile(e.z),i=tileKey(t,l);infectedTiles[i]||(bombs.push({x:e.x,y:e.y,z:e.z,k:i}),"undefined"!=typeof gameSFX&&gameSFX.playBombDrop("normal",e.x,e.y,e.z))}}}function updateSquid(e,t,l){let i=findNearest(t,e.x,e.y,e.z)||l,o=i.x-e.x,r=i.y-e.y,n=i.z-e.z,a=Math.hypot(o,r,n);a>0&&(e.vx=lerp(e.vx||0,o/a*3.5,.05),e.vy=lerp(e.vy||0,r/a*3.5,.05),e.vz=lerp(e.vz||0,n/a*3.5,.05));let s=getAltitude(e.x,e.z);e.y>s-150&&(e.vy-=1),e.x+=e.vx,e.y+=e.vy,e.z+=e.vz,frameCount%5==0&&particles.push({x:e.x+random(-10,10),y:e.y+random(-10,10),z:e.z+random(-10,10),isFog:!0,vx:.2*e.vx+random(-.5,.5),vy:.2*e.vy+random(-.5,.5),vz:.2*e.vz+random(-.5,.5),life:255,decay:3,size:random(30,80),color:[10,10,12]})}function getEnemyColor(e){return"fighter"===e?[255,150,0]:"bomber"===e?[180,20,180]:"crab"===e?[200,80,20]:"hunter"===e?[40,255,40]:"squid"===e?[100,100,150]:[220,30,30]}function explosion(e,t,l,i,o){"undefined"!=typeof gameSFX&&(o?gameSFX.playExplosion("bomber"===o||"mega"===o,o,e,t,l):gameSFX.playExplosion(null==i,"",e,t,l));let r=null!=i;for(let o=0;o<350;o++){let o=random(5,45),n=random(TWO_PI),a=random(TWO_PI),s=255,p=200,f=50,d=200,u=30,m=10,h=40,c=20,x=20;if(r){let e=i[0]+random(-15,15),t=i[1]+random(-15,15),l=i[2]+random(-15,15);random()>.6&&(e=lerp(e,255,.8),t=lerp(t,255,.8),l=lerp(l,255,.4)),s=constrain(e,0,255),p=constrain(t,0,255),f=constrain(l,0,255),d=.8*s,u=.8*p,m=.8*f,h=.3*s+10,c=.3*p+10,x=.3*f+10}particles.push({x:e,y:t,z:l,cx:e,cy:t,cz:l,isExplosion:!0,hasExpColor:r,br:s,bg:p,bb:f,er:d,eg:u,eb:m,sr:h,sg:c,sb:x,vx:o*sin(n)*cos(a),vy:o*sin(n)*sin(a),vz:o*cos(n),life:255,decay:random(2,6),size:random(8,26)})}}function keyPressed(){if("menu"!==gameState)for(let e of players)keyCode===e.keys.missile&&fireMissile(e);else"1"===key?startGame(1):"2"===key&&startGame(2)}function touchStarted(e){return"function"==typeof handleTouchStarted&&handleTouchStarted()}function touchEnded(e){return!1}function touchMoved(e){return!1}function mousePressed(){isMobile||(fullscreen()||fullscreen(!0),"menu"===gameState?startGame(1):"playing"===gameState&&(mouseButton===CENTER&&players.length>0&&!players[0].dead&&fireMissile(players[0]),requestPointerLock()))}function mouseDragged(){mouseMoved()}function mouseMoved(){}function windowResized(){resizeCanvas(windowWidth,windowHeight)}