let TILE=120,SEA=200,LAUNCH_ALT=100,GRAV=.09,VIEW_NEAR=20,VIEW_FAR=30,FOG_START=2e3,FOG_END=4e3,SKY_R=30,SKY_G=60,SKY_B=120,ORTHO_DIRS=[[1,0],[-1,0],[0,1],[0,-1]],MAX_INF=2e3,INF_RATE=.01,CLEAR_R=3,LAUNCH_MIN=0,LAUNCH_MAX=800,TREE_VARIANTS=[{infected:[180,30,20],healthy:[25,130,20],cones:[[12,45,20]]},{infected:[190,35,25],healthy:[30,145,25],cones:[[22,28,10]],infected2:[150,20,15],healthy2:[25,120,20],cones2:[[15,22,28]]},{infected:[170,30,22],healthy:[35,135,28],cones:[[9,60,28]]}],YAW_RATE=.04,PITCH_RATE=.03,P1_KEYS={thrust:87,left:65,right:68,brake:83,pitchUp:82,pitchDown:70,shoot:81,missile:69},P2_KEYS={thrust:38,left:37,right:39,brake:40,pitchUp:186,pitchDown:222,shoot:190,missile:191},trees=[],particles=[],enemies=[],buildings=[],bombs=[],enemyBullets=[],infectedTiles={},level=1,currentMaxEnemies=2,levelComplete=!1,infectionStarted=!1,levelEndTime=0,gameFont,gameState="menu",gameStartTime=0,numPlayers=1,menuStars=[],players=[],altCache=new Map,isMobile=!1,isAndroid=!1;function checkMobile(){isAndroid=/Android/i.test(navigator.userAgent),isMobile=isAndroid||/webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||0<navigator.maxTouchPoints}let tileKey=(e,t)=>e+","+t,toTile=e=>Math.floor(e/TILE),isLaunchpad=(e,t)=>e>=LAUNCH_MIN&&e<=LAUNCH_MAX&&t>=LAUNCH_MIN&&t<=LAUNCH_MAX,aboveSea=e=>e>=SEA-1;function inFrustum(e,t,i,l,r,o){return(i-e)*r+(l-t)*o>2*-TILE}function fogBlend(e,t,i,l){l=constrain((l-FOG_START)/(FOG_END-FOG_START),0,1);return[lerp(e,SKY_R,l),lerp(t,SKY_G,l),lerp(i,SKY_B,l)]}function shipUpDir(e){var t=sin(e.pitch),i=cos(e.pitch);return{x:t*-sin(e.yaw),y:-i,z:t*-cos(e.yaw)}}function resetShip(e,t){e.ship={x:t,y:LAUNCH_ALT,z:400,vx:0,vy:0,vz:0,pitch:0,yaw:0}}function createPlayer(e,t,i,l){e={id:e,keys:t,labelColor:l,score:0,dead:!1,respawnTimer:0,bullets:[],homingMissiles:[],missilesRemaining:1,mobileMissilePressed:!1};return resetShip(e,i),e}function fireMissile(e){0<e.missilesRemaining&&!e.dead&&(e.missilesRemaining--,e.homingMissiles.push(spawnProjectile(e.ship,8,300)))}function drawShadow(e,t,i,l,r){aboveSea(t)||(push(),translate(e,t-.5,i),rotateX(PI/2),fill(0,0,0,50),ellipse(0,0,l,r),pop())}function drawShipShadow(e,t,i,l,r){var o;aboveSea(t)||(o=max(1,.012*(t-r)),r=map(t-r,0,600,60,15,!0),push(),translate(e,t-.3,i),rotateY(l),noStroke(),fill(0,0,0,r),beginShape(),vertex(-15*o,0,15*o),vertex(15*o,0,15*o),vertex(0,0,-25*o),endShape(CLOSE),pop())}function setup2DViewport(){var e=pixelDensity();drawingContext.viewport(0,0,width*e,height*e),push(),ortho(-width/2,width/2,-height/2,height/2,0,1e3),resetMatrix()}function drawTileBatch(e){if(e.length){beginShape(TRIANGLES);for(var t of e){fill(t.r,t.g,t.b);t=t.v;vertex(t[0],t[1],t[2]),vertex(t[3],t[4],t[5]),vertex(t[6],t[7],t[8]),vertex(t[9],t[10],t[11]),vertex(t[12],t[13],t[14]),vertex(t[15],t[16],t[17])}endShape()}}function clearInfectionRadius(i,l){let r=0;for(let t=-CLEAR_R;t<=CLEAR_R;t++)for(let e=-CLEAR_R;e<=CLEAR_R;e++){var o=tileKey(i+t,l+e);infectedTiles[o]&&(delete infectedTiles[o],r++)}return r}function findNearest(e,t,i,l){let r=null,o=1/0;for(var s of e){var n=dist(t,i,l,s.x,s.y,s.z);n<o&&(o=n,r=s)}return{target:r,dist:o}}function spawnProjectile(e,t,i){var l=cos(e.pitch),r=sin(e.pitch),o=cos(e.yaw),s=sin(e.yaw),n=10*r+-30*l;return{x:e.x+n*s,y:e.y+(10*l- -30*r),z:e.z+n*o,vx:-l*s*t+e.vx,vy:r*t+e.vy,vz:-l*o*t+e.vz,life:i}}function preload(){gameFont=loadFont("https://cdnjs.cloudflare.com/ajax/libs/topcoat/0.8.0/font/SourceCodePro-Bold.otf")}function setup(){checkMobile(),createCanvas(windowWidth,windowHeight,WEBGL),textFont(gameFont),randomSeed(42);for(let e=0;e<250;e++)trees.push({x:random(-5e3,5e3),z:random(-5e3,5e3),variant:floor(random(3)),trunkH:random(25,50),canopyScale:random(1,1.8)});for(let e=0;e<120;e++)menuStars.push({x:random(-1,1),y:random(-1,1),s:random(1,3),spd:random(.3,1.2)});randomSeed(123);for(let e=0;e<40;e++)buildings.push({x:random(-4500,4500),z:random(-4500,4500),w:random(40,100),h:random(50,180),d:random(40,100),type:floor(random(4)),col:[random(80,200),random(80,200),random(80,200)]});gameState="menu"}function startGame(e){numPlayers=e,gameStartTime=millis(),players=1===e?[createPlayer(0,P1_KEYS,400,[80,180,255])]:[createPlayer(0,P1_KEYS,300,[80,180,255]),createPlayer(1,P2_KEYS,500,[255,180,80])],startLevel(1),gameState="playing"}function startLevel(e){level=e,levelComplete=!1,infectionStarted=!1,currentMaxEnemies=1+level;for(var t of players)resetShip(t,1===numPlayers?400:0===t.id?300:500),t.homingMissiles=[],t.missilesRemaining=1,t.dead=!1,t.respawnTimer=0;enemies=[],bombs=[],enemyBullets=[];for(let e=0;e<currentMaxEnemies;e++)spawnEnemy();infectedTiles={}}function spawnEnemy(){var e=0<level&&random()<.4;enemies.push({x:random(-4e3,4e3),y:random(-300,-800),z:random(-4e3,4e3),vx:random(-2,2),vz:random(-2,2),id:random(),type:e?"fighter":"seeder",fireTimer:0})}function drawMenu(){background(8,12,28),setup2DViewport(),noStroke();for(var e of menuStars){e.y+=.002*e.spd,1<e.y&&(e.y-=2);var t=e.x*width/2,i=e.y*height/2,l=150+105*sin(.05*frameCount+100*e.x);fill(l,l,30+l,l),ellipse(t,i,e.s,e.s)}var r=.3*sin(.04*frameCount)+.7,r=(noStroke(),fill(0,255,60,18*r),ellipse(0,.14*-height,500*r,140*r),fill(0,255,60,10*r),ellipse(0,.14*-height,700*r,200*r),textAlign(CENTER,CENTER),noStroke(),fill(0,180,40,80),textSize(110),text("V I R U S",3,.14*-height+4),30*sin(.06*frameCount));fill(30+r,255,60+r),textSize(110),text("V I R U S",0,.14*-height),textSize(16),fill(140,200,140,180),text("Christian Nold, 2026",0,.14*-height+70);for(let e=-height/2;e<height/2;e+=4)stroke(0,0,0,20),strokeWeight(1),line(-width/2,e,width/2,e);noStroke();var r=.08*height,o=.3*sin(.08*frameCount)+.7,s=.3*sin(.08*frameCount+1.5)+.7;textSize(28),isMobile?(fill(255,255,255,255*o),text("TAP TO START",0,25+r)):(fill(255,255,255,255*o),text("PRESS 1 — SINGLE PLAYER",0,r),fill(255,255,255,255*s),text("PRESS 2 — MULTIPLAYER",0,50+r)),textSize(13),fill(100,140,100,150),isMobile?text("Use virtual joystick and buttons to play",0,height/2-40):(text("P1: Mouse/WASD + R/F pitch  Q shoot  E missile",0,height/2-55),text("P2: ARROWS + ;/' pitch  . shoot  / missile",0,height/2-35)),pop()}function drawGameOver(){setup2DViewport(),drawingContext.clear(drawingContext.DEPTH_BUFFER_BIT),fill(255,60,60),textAlign(CENTER,CENTER),textSize(80),text("GAME OVER",0,-50),textSize(24),fill(180,200,180),text("INFECTION REACHED CRITICAL MASS",0,40),pop(),5e3<millis()-levelEndTime&&(gameState="menu")}function renderPlayerView(e,t,i,l,r,o,s){var n,a=t.ship,l=l*s,p=r*s,s=o*s,l=(e.viewport(l,0,p,s),e.enable(e.SCISSOR_TEST),e.scissor(l,0,p,s),e.clearColor(30/255,60/255,120/255,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),push(),perspective(PI/3,r/o,50,VIEW_FAR*TILE*1.5),min(a.y-120,SEA-60));camera(a.x+550*sin(a.yaw),l,a.z+550*cos(a.yaw),a.x,a.y,a.z,0,1,0),directionalLight(240,230,210,.5,.8,-.3),ambientLight(60,60,70),drawLandscape(a),drawSea(a),drawTrees(a),drawBuildings(a),drawEnemies(a.x,a.z);for(n of players)n.dead||shipDisplay(n.ship,n.labelColor),renderProjectiles(n,a.x,a.z);renderParticles(a.x,a.z),pop(),e.clear(e.DEPTH_BUFFER_BIT),drawPlayerHUD(t,i,r,o),isMobile&&1===numPlayers&&mobileControls.draw(),e.disable(e.SCISSOR_TEST)}function draw(){if("menu"===gameState)drawMenu();else if("gameover"===gameState)drawGameOver();else{1e4<altCache.size&&altCache.clear();var e,t,i,l=drawingContext;isMobile&&1===numPlayers&&mobileControls.update();for(e of players)updateShipInput(e);updateEnemies();for(t of players)checkCollisions(t);spreadInfection(),updateParticlePhysics();for(i of players)updateProjectilePhysics(i);var r=height,o=pixelDensity();if(1===numPlayers)renderPlayerView(l,players[0],0,0,width,r,o);else{var s=floor(width/2);for(let e=0;e<2;e++)renderPlayerView(l,players[e],e,e*s,s,r,o)}setup2DViewport(),2===numPlayers&&(stroke(0,255,0,180),strokeWeight(2),line(0,-height/2,0,height/2)),levelComplete&&(noStroke(),fill(0,255,0),textAlign(CENTER,CENTER),textSize(40),text("LEVEL "+level+" COMPLETE",0,0)),pop();var n,a=Object.keys(infectedTiles).length;(infectionStarted=0<a?!0:infectionStarted)&&0===a&&!levelComplete&&(levelComplete=!0,levelEndTime=millis()),levelComplete&&4e3<millis()-levelEndTime&&startLevel(level+1);for(n of players)n.dead&&(n.respawnTimer--,n.respawnTimer<=0)&&(n.dead=!1,resetShip(n,1===numPlayers?400:0===n.id?300:500))}}function spreadInfection(){if(frameCount%5==0){var t=Object.keys(infectedTiles),i=t.length;if(i>=MAX_INF)"gameover"!==gameState&&(gameState="gameover",levelEndTime=millis());else{var l,r,o,s=[];for(let e=0;e<i;e++)random()>INF_RATE||(l=+(o=t[e].split(","))[0],o=+o[1],r=l+(l=ORTHO_DIRS[floor(random(4))])[0],o=o+l[1],l=tileKey(r,o),r=r*TILE,o=o*TILE,isLaunchpad(r,o))||aboveSea(getAltitude(r,o))||infectedTiles[l]||s.push(l);var n=s.length;for(let e=0;e<n;e++)infectedTiles[s[e]]={tick:frameCount}}}}function clearInfectionAt(e,t,i){var l=toTile(e),r=toTile(t);return!!infectedTiles[tileKey(l,r)]&&(0<(l=clearInfectionRadius(l,r))&&(explosion(e,getAltitude(e,t)-10,t),i)&&(i.score+=100),0<l)}let mobileControls={leftTouchId:null,joyCenter:null,joyPos:null,btns:{thrust:{active:!1,r:40,col:[0,255,60],label:"THR",x:0,y:0},shoot:{active:!1,r:50,col:[255,60,60],label:"SHT",x:0,y:0},missile:{active:!1,r:35,col:[0,200,255],label:"MSL",x:0,y:0}},update(){if(isMobile&&"playing"===gameState){var e,i=width,l=height;for(e in this.btns.thrust.x=i-180,this.btns.thrust.y=l-70,this.btns.shoot.x=i-70,this.btns.shoot.y=l-70,this.btns.missile.x=i-70,this.btns.missile.y=l-180,this.btns)this.btns[e].active=!1;let t=!1;for(let e=0;e<touches.length;e++){var r=touches[e];if(r.x>i/2)for(var o in this.btns)dist(r.x,r.y,this.btns[o].x,this.btns[o].y)<1.5*this.btns[o].r&&(this.btns[o].active=!0);else this.leftTouchId===r.id?(this.joyPos={x:r.x,y:r.y},t=!0):this.leftTouchId||(this.leftTouchId=r.id,this.joyCenter={x:r.x,y:r.y},this.joyPos={x:r.x,y:r.y},t=!0)}t||(this.leftTouchId=null,this.joyCenter=null,this.joyPos=null)}},draw(){var e,t,i;for(i in setup2DViewport(),push(),translate(-width/2,-height/2,0),this.joyCenter&&this.joyPos&&(noStroke(),fill(255,255,255,40),circle(this.joyCenter.x,this.joyCenter.y,140),fill(255,255,255,120),t=dist(this.joyCenter.x,this.joyCenter.y,this.joyPos.x,this.joyPos.y),e=atan2(this.joyPos.y-this.joyCenter.y,this.joyPos.x-this.joyCenter.x),t=min(t,70),circle(this.joyCenter.x+cos(e)*t,this.joyCenter.y+sin(e)*t,50)),this.btns){var l=this.btns[i];stroke(l.col[0],l.col[1],l.col[2],l.active?200:80),strokeWeight(2),fill(l.col[0],l.col[1],l.col[2],l.active?80:20),circle(l.x,l.y,2*l.r),noStroke(),fill(255,l.active?255:150),textAlign(CENTER,CENTER),textSize(max(10,.4*l.r)),text(l.label,l.x,l.y)}pop()}};function updateShipInput(i){var l=i.ship;if(!i.dead){var r=i.keys;let e=keyIsDown(r.thrust);var o,s,n,a,p=keyIsDown(r.brake);let t=keyIsDown(r.shoot)||1===numPlayers&&!isMobile&&mouseIsPressed&&mouseButton===LEFT&&300<millis()-gameStartTime;isMobile&&0===i.id&&(mobileControls.btns.thrust.active&&(e=!0),mobileControls.btns.shoot.active&&(t=!0),mobileControls.btns.missile.active&&!i.mobileMissilePressed?(fireMissile(i),i.mobileMissilePressed=!0):mobileControls.btns.missile.active||(i.mobileMissilePressed=!1),mobileControls.joyCenter)&&mobileControls.joyPos&&100<(s=(a=mobileControls.joyPos.x-mobileControls.joyCenter.x)*a+(o=mobileControls.joyPos.y-mobileControls.joyCenter.y)*o)&&(s=sqrt(s),n=min(1,(s-10)/60),l.yaw+=-a/s*YAW_RATE*n,a=o/s*PITCH_RATE*n*.5,l.pitch=constrain(l.pitch-a,-PI/2.2,PI/2.2)),keyIsDown(r.left)&&(l.yaw+=YAW_RATE),keyIsDown(r.right)&&(l.yaw-=YAW_RATE),keyIsDown(r.pitchUp)&&(l.pitch=constrain(l.pitch+PITCH_RATE,-PI/2.2,PI/2.2)),keyIsDown(r.pitchDown)&&(l.pitch=constrain(l.pitch-PITCH_RATE,-PI/2.2,PI/2.2)),l.vy+=GRAV,e&&(o=shipUpDir(l),l.vx+=.45*o.x,l.vy+=.45*o.y,l.vz+=.45*o.z,frameCount%2==0)&&(s=random(-1,1),n=random(-1,1),a=random(-1,1),particles.push({x:l.x,y:l.y,z:l.z,vx:8*-o.x+s,vy:8*-o.y+n,vz:8*-o.z+a,life:255})),p&&(l.vx*=.96,l.vy*=.96,l.vz*=.96),t&&frameCount%6==0&&i.bullets.push(spawnProjectile(l,25,300)),l.vx*=.985,l.vy*=.985,l.vz*=.985,l.x+=l.vx,l.y+=l.vy,l.z+=l.vz,l.y>SEA-12?(explosion(l.x,SEA,l.z),killPlayer(i)):(r=getAltitude(l.x,l.z),l.y>r-12&&(2.8<l.vy?killPlayer(i):(l.y=r-12,l.vy=0,l.vx*=.8,l.vz*=.8)))}}function killPlayer(e){e.dead=!0,e.respawnTimer=120,e.bullets=[]}function checkCollisions(r){if(!r.dead){var e=r.ship,o=e.x,s=e.y,n=e.z;for(let e=enemyBullets.length-1;0<=e;e--){var t=enemyBullets[e];if(dist(t.x,t.y,t.z,o,s,n)<70)return explosion(o,s,n),killPlayer(r),void enemyBullets.splice(e,1)}let l=r.bullets.length;for(let i=enemies.length-1;0<=i;i--){var a=enemies[i],p=a.x,h=a.y,d=a.z;let t=!1;for(let e=l-1;0<=e;e--){var f=r.bullets[e];if(dist(f.x,f.y,f.z,p,h,d)<80){explosion(p,h,d),enemies.splice(i,1),r.bullets.splice(e,1),l--,r.score+=100,t=!0;break}}!t&&dist(o,s,n,p,h,d)<70&&killPlayer(r)}var u=trees.length,c=r.bullets;let i=0;for(let t=c.length-1;0<=t;t--){var y=c[t],x=y.x,v=y.y,m=y.z;for(let e=0;e<u;e++){var g=trees[e],E=g.x,T=g.z,S=getAltitude(E,T);if(dist(x,m,E,T)<60&&v>S-g.trunkH-30*g.canopyScale-10&&v<S+10){var b=toTile(E),z=toTile(T);if(infectedTiles[tileKey(b,z)]){clearInfectionRadius(b,z),explosion(E,S-g.trunkH,T),i+=200,c.splice(t,1);break}}}}r.score+=i}}function updateParticlePhysics(){for(let e=particles.length-1;0<=e;e--){var t=particles[e];t.x+=t.vx,t.y+=t.vy,t.z+=t.vz,t.life-=10,t.life<=0&&particles.splice(e,1)}for(let e=bombs.length-1;0<=e;e--){var i=bombs[e],l=(i.y+=8,getAltitude(i.x,i.z));i.y>l&&(explosion(i.x,l,i.z),isLaunchpad(i.x,i.z)||(infectedTiles[i.k]={tick:frameCount}),bombs.splice(e,1))}for(let e=enemyBullets.length-1;0<=e;e--){var r=enemyBullets[e];r.x+=r.vx,r.y+=r.vy,r.z+=r.vz,r.life-=2,(r.life<=0||r.y>getAltitude(r.x,r.z)||r.y>SEA)&&enemyBullets.splice(e,1)}}function updateProjectilePhysics(i){for(let e=i.bullets.length-1;0<=e;e--){var t=i.bullets[e];t.x+=t.vx,t.y+=t.vy,t.z+=t.vz,t.life-=2,t.life<=0?i.bullets.splice(e,1):t.y>getAltitude(t.x,t.z)&&(clearInfectionAt(t.x,t.z,i),i.bullets.splice(e,1))}for(let e=i.homingMissiles.length-1;0<=e;e--){var l,r=i.homingMissiles[e],o=findNearest(enemies,r.x,r.y,r.z).target,s=(o&&(s=o.x-r.x,n=o.y-r.y,o=o.z-r.z,0<(l=sqrt(s*s+n*n+o*o)))&&(r.vx=lerp(r.vx,s/l*10,.12),r.vy=lerp(r.vy,n/l*10,.12),r.vz=lerp(r.vz,o/l*10,.12)),sqrt(r.vx*r.vx+r.vy*r.vy+r.vz*r.vz));0<s&&(r.vx=r.vx/s*10,r.vy=r.vy/s*10,r.vz=r.vz/s*10),r.x+=r.vx,r.y+=r.vy,r.z+=r.vz,r.life--,frameCount%2==0&&particles.push({x:r.x,y:r.y,z:r.z,vx:random(-.5,.5),vy:random(-.5,.5),vz:random(-.5,.5),life:120});let t=!1;for(let e=enemies.length-1;0<=e;e--)if(dist(r.x,r.y,r.z,enemies[e].x,enemies[e].y,enemies[e].z)<100){explosion(enemies[e].x,enemies[e].y,enemies[e].z),enemies.splice(e,1),i.score+=250,t=!0;break}var n=getAltitude(r.x,r.z);(t||r.life<=0||r.y>n)&&(!t&&r.y>n&&(explosion(r.x,r.y,r.z),clearInfectionAt(r.x,r.z,i)),i.homingMissiles.splice(e,1))}}function renderParticles(e,t){var i,l,r,o=.6*FOG_END*(.6*FOG_END);for(i of particles){var s=i.x-e,n=i.z-t;o<s*s+n*n||(push(),translate(i.x,i.y,i.z),noStroke(),fill(255,150,0,i.life),box(4),pop())}for(l of bombs)push(),translate(l.x,l.y,l.z),noStroke(),fill(200,50,50),box(8,20,8),pop();for(r of enemyBullets)push(),translate(r.x,r.y,r.z),noStroke(),fill(255,80,80),box(6),pop()}function renderProjectiles(e,t,i){var l,r,o=.8*FOG_END*(.8*FOG_END);for(l of e.bullets){var s=l.x-t,n=l.z-i;o<s*s+n*n||(push(),translate(l.x,l.y,l.z),noStroke(),fill(e.labelColor[0],e.labelColor[1],e.labelColor[2]),box(6),pop())}for(r of e.homingMissiles){var a=r.x-t,p=r.z-i;o<a*a+p*p||(push(),translate(r.x,r.y,r.z),noStroke(),fill(0,200,255),box(10),pop())}}function drawPlayerHUD(e,t,i,l){var r,o,s,n,a,p=e.ship,h=(push(),ortho(-i/2,i/2,-l/2,l/2,0,1e3),resetMatrix(),noStroke(),textAlign(LEFT,TOP),-i/2+14),d=-l/2,f=e.labelColor,f=(textSize(16),fill(f[0],f[1],f[2]),text("P"+(t+1),h,6+d),[[20,[255,255,255],"SCORE "+e.score,h,26+d],[16,[0,255,0],"ALT "+max(0,floor(SEA-p.y)),h,50+d],[14,[255,80,80],"INF "+Object.keys(infectedTiles).length,h,72+d],[14,[255,100,100],"ENEMIES "+enemies.length,h,90+d],[14,[0,200,255],"MISSILES "+e.missilesRemaining,h,108+d]]);for([r,o,s,n,a]of f)textSize(r),fill(o[0],o[1],o[2]),text(s,n,a);textSize(16),fill(255),textAlign(RIGHT,TOP),text("LVL "+level,i/2-14,6+d),e.dead&&(fill(255,0,0,200),textAlign(CENTER,CENTER),textSize(28),text("DESTROYED",0,0),textSize(16),fill(200),text("Respawning...",0,30)),drawRadarForPlayer(e,i,l),drawControlHints(e,t,i,l),pop()}function drawRadarForPlayer(e,t,i){var l,r=e.ship;push(),translate(t/2-70,-i/2+80,0),fill(0,150),stroke(0,255,0),strokeWeight(1.5),rectMode(CENTER),rect(0,0,110,110),rotateZ(r.yaw),fill(180,0,0,80),noStroke();for(l of Object.keys(infectedTiles)){var[o,s]=l.split(",").map(Number),o=.012*(o*TILE-r.x),s=.012*(s*TILE-r.z);abs(o)<50&&abs(s)<50&&rect(o,s,2,2)}var n,t=.012*(400-r.x),i=.012*(400-r.z);abs(t)<50&&abs(i)<50&&(fill(255,255,0,150),noStroke(),rect(t,i,4,4)),fill(255,0,0),noStroke();for(n of enemies){var a=.012*(n.x-r.x),p=.012*(n.z-r.z);abs(a)<50&&abs(p)<50?rect(a,p,3,3):(push(),translate(constrain(a,-49,49),constrain(p,-49,49),0),rotateZ(atan2(p,a)),fill(255,0,0,180),triangle(3,0,-2,-2,-2,2),pop())}t=players[1-e.id];t&&!t.dead&&(i=.012*(t.ship.x-r.x),e=.012*(t.ship.z-r.z),fill(t.labelColor[0],t.labelColor[1],t.labelColor[2],200),noStroke(),abs(i)<50)&&abs(e)<50&&rect(i,e,4,4),rotateZ(-r.yaw),fill(255,255,0),rect(0,0,4,4),pop()}function drawControlHints(e,t,i,l){push(),textAlign(CENTER,BOTTOM),textSize(11),fill(255,255,255,120);let r="";r=1===numPlayers?"W thrust  Mouse pitch/yaw  Q/LMB shoot  E missile  S brake  (Click to lock mouse)":0===t?"W thrust  A/D turn  R/F pitch  Q shoot  E missile  S brake":"↑ thrust  ←/→ turn  ;/' pitch  . shoot  / missile  ↓ brake",text(r,0,l/2-8),pop()}function getGridAltitude(e,t){var i=tileKey(e,t),l=altCache.get(i);if(void 0!==l)return l;var l=e*TILE,e=t*TILE;let r;return r=isLaunchpad(l,e)?LAUNCH_ALT:(t=8e-4*l,l=8e-4*e,e=noise(t,l)+.5*noise(2.5*t,2.5*l)+.25*noise(5*t,5*l),300-550*(e=Math.pow(e/1.75,2))),altCache.set(i,r),r}function getAltitude(e,t){var i,l,r,o,s;return isLaunchpad(e,t)?LAUNCH_ALT:(s=Math.floor(e/TILE),i=Math.floor(t/TILE),e=(e-s*TILE)/TILE,t=(t-i*TILE)/TILE,0==e&&0==t?getGridAltitude(s,i):(l=getGridAltitude(s,i),r=getGridAltitude(s+1,i),o=getGridAltitude(s,i+1),s=getGridAltitude(s+1,i+1),e+t<=1?l+(r-l)*e+(o-l)*t:s+(o-s)*(1-e)+(r-s)*(1-t)))}function drawLandscape(i){var l=toTile(i.x),r=toTile(i.z);noStroke();let o=[],s=[];VIEW_NEAR,VIEW_NEAR;var n=-sin(i.yaw),a=-cos(i.yaw);for(let t=r-VIEW_FAR;t<r+VIEW_FAR;t++)for(let e=l-VIEW_FAR;e<=l+VIEW_FAR;e++){var p=e*TILE+.5*TILE,h=t*TILE+.5*TILE;if(e>=l-VIEW_NEAR&&e<=l+VIEW_NEAR&&t>=r-VIEW_NEAR&&t<=r+VIEW_NEAR||inFrustum(i.x,i.z,p,h,n,a)){T=E=g=m=v=x=y=c=u=f=d=h=p=void 0;var p=e,h=t,d=p*TILE,f=h*TILE,u=d+TILE,c=f+TILE,y=getAltitude(d,f),x=getAltitude(u,f),v=getAltitude(d,c),m=getAltitude(u,c),g=.25*(y+x+v+m);if(!aboveSea(g)){var E=d+.5*TILE,T=f+.5*TILE,E=i.x-E,T=i.z-T,E=sqrt(E*E+T*T),T=(p+h)%2==0,y=[d,y,f,u,x,f,d,v,c,u,x,f,u,m,c,d,v,c];if(isLaunchpad(d,f))[u,m,v]=fogBlend(x=T?190:140,x,x,E),s.push({v:y,r:u,g:m,b:v});else if(infectedTiles[tileKey(p,h)])c=.5*sin(.08*frameCount+.5*p+.3*h)+.5,d=map(g,-100,SEA,1.15,.65),f=T?[160,255,10,40,10,25]:[120,200,5,25,5,15],[x,u,m]=fogBlend(lerp(f[0],f[1],c)*d,lerp(f[2],f[3],c)*d,lerp(f[4],f[5],c)*d,E),o.push({v:y,r:x,g:u,b:m});else{v=43758.5453*Math.abs(Math.sin(12.9898*p+78.233*h));v-=Math.floor(v);let e,t,i;i=(g>SEA-15?(f=[[230,210,80],[200,180,60],[150,180,50]][Math.floor(3*v)],e=f[0],t=f[1],f):(c=[[60,180,60],[30,120,40],[180,200,50],[220,200,80],[210,130,140],[180,140,70]],d=noise(.15*p,.15*h),x=c[Math.floor(6*(2*d+.2*v))%6],e=x[0],t=x[1],x))[2];var u=T?e:.85*e,m=T?t:.85*t,g=T?i:.85*i,f=constrain((E-.5*FOG_START)/(.4*FOG_END),0,1),[p,h,c]=fogBlend(lerp(u,.9*e,f),lerp(m,.9*t,f),lerp(g,.9*i,f),E);s.push({v:y,r:p,g:h,b:c})}}}}drawTileBatch(s),push(),noStroke(),fill(80,80,75);var e=LAUNCH_MAX-LAUNCH_MIN,t=LAUNCH_ALT+2,S=SEA-t+10,b=(translate(.5*(LAUNCH_MIN+LAUNCH_MAX),t+.5*S,.5*(LAUNCH_MIN+LAUNCH_MAX)),box(e,S,e),pop(),push(),LAUNCH_MAX-100);for(let e=LAUNCH_MIN+200;e<=LAUNCH_MAX-200;e+=120){var z=i.x-b,A=i.z-e,z=sqrt(z*z+A*A),[A,w,C]=fogBlend(255,140,20,z);fill(A,w,C),push(),translate(b,LAUNCH_ALT,e),fill(...fogBlend(60,60,60,z)),push(),translate(0,-10,0),box(30,20,30),pop(),fill(A,w,C),push(),translate(0,-70,0),rotateX(Math.PI),cone(18,100,4,1),pop(),pop()}pop(),drawTileBatch(o)}function drawSea(e){noStroke();var t=8*sin(.03*frameCount),t=(fill(15,45+t,150+t),VIEW_FAR*TILE*2);push(),translate(e.x,SEA+3,e.z),box(t,2,t),pop()}function drawTrees(e){var t,i=VIEW_FAR*TILE,l=i*i,r=-sin(e.yaw),o=-cos(e.yaw);for(t of trees){var s,n,a,p,h,d,f,u=e.x-t.x,c=e.z-t.z,u=u*u+c*c;l<=u||inFrustum(e.x,e.z,t.x,t.z,r,o)&&(c=getAltitude(t.x,t.z),aboveSea(c)||isLaunchpad(t.x,t.z)||(u=sqrt(u),{trunkH:c,canopyScale:s,variant:d}=(push(),translate(t.x,c,t.z),noStroke(),t),[n,h,a]=fogBlend((f=!!infectedTiles[tileKey(toTile(t.x),toTile(t.z))])?80:100,f?40:65,f?20:25,u),fill(n,h,a),push(),translate(0,-c/2,0),box(5,c,5),pop(),n=TREE_VARIANTS[d],h=2===d,[d,a,p]=fogBlend((a=f?n.infected:n.healthy)[0],a[1],a[2],u),fill(d,a,p),h?(push(),translate(0,-c,0),cone(35*s,15*s,6,1),pop()):(d=n.cones[0],push(),translate(0,-c-d[2]*s,0),cone(d[0]*s,d[1]*s,4,1),pop(),n.cones2&&([p,h,d]=fogBlend((a=f?n.infected2:n.healthy2)[0],a[1],a[2],u),fill(p,h,d),f=n.cones2[0],push(),translate(0,-c-f[2]*s,0),cone(f[0]*s,f[1]*s,4,1),pop())),u<1500&&(push(),translate(0,-.5,8),rotateX(PI/2),fill(0,0,0,40),ellipse(0,0,20*s,12*s),pop()),pop()))}}function drawBuildings(e){var t,i=VIEW_FAR*TILE*VIEW_FAR*TILE,l=-sin(e.yaw),r=-cos(e.yaw);for(t of buildings){var o,s,n,a,p,h,d,f,u,c,y=e.x-t.x,x=e.z-t.z;i<=y*y+x*x||inFrustum(e.x,e.z,t.x,t.z,l,r)&&(o=getAltitude(t.x,t.z),aboveSea(o)||isLaunchpad(t.x,t.z)||(y=sqrt(y*y+x*x),x=!!infectedTiles[tileKey(toTile(t.x),toTile(t.z))],push(),translate(t.x,o,t.z),noStroke(),0===t.type?([a,s,n]=fogBlend((a=x?[200,50,50]:[220,220,220])[0],a[1],a[2],y),fill(a,s,n),push(),translate(0,-t.h/2,0),box(t.w,t.h,t.d),pop(),[s,n,a]=fogBlend((a=x?[150,30,30]:[220,50,50])[0],a[1],a[2],y),fill(s,n,a),push(),translate(0,-t.h-t.w/3,0),rotateY(PI/4),cone(.8*t.w,t.w/1.5,4,1)):1===t.type?([n,a,p]=fogBlend((s=x?[200,50,50]:[150,160,170])[0],s[1],s[2],y),fill(n,a,p),push(),translate(0,-t.h/2,0),cylinder(t.w/2,t.h,8,1),pop(),[p,h,d]=fogBlend((p=x?[150,30,30]:[80,180,220])[0],p[1],p[2],y),fill(p,h,d),push(),translate(0,-t.h,0),sphere(t.w/2,8,8)):2===t.type?([h,d,f]=fogBlend((p=x?[200,50,50]:t.col)[0],p[1],p[2],y),fill(h,d,f),push(),translate(0,-t.h/4,0),box(1.5*t.w,t.h/2,1.5*t.d),pop(),push(),translate(.3*t.w,-t.h/2-t.h/8,.2*-t.d),box(t.w/2,t.h/4,t.d/2),pop(),[f,u,c]=fogBlend((f=x?[120,20,20]:[80,80,80])[0],f[1],f[2],y),fill(f,u,c),push(),translate(.4*-t.w,-t.h,.4*t.d),cylinder(.15*t.w,t.h,8,1)):([u,c,x]=fogBlend((f=x?[200,50,50]:[60,180,240])[0],f[1],f[2],y),fill(u,c,x),push(),x=o-t.h-100-50*sin(.02*frameCount+t.x),translate(0,x-o,0),rotateY(.01*frameCount+t.x),rotateZ(.015*frameCount+t.z),cone(t.w,t.h/2,4,1),rotateX(PI),cone(t.w,t.h/2,4,1)),pop(),pop(),y<1500&&drawShadow(t.x,o,t.z,1.5*t.w,1.5*t.d)))}}function shipDisplay(e,t){push(),translate(e.x,e.y,e.z),rotateY(e.yaw),rotateX(e.pitch),stroke(0);var i,l,r,o,s,n,a=t[0],p=t[1],t=t[2];for([i,l,r,o,s,n]of[[lerp(200,a,.3),lerp(200,p,.3),lerp(200,t,.3),[-15,10,15],[15,10,15],[0,10,-25]],[lerp(170,a,.2),lerp(170,p,.2),lerp(170,t,.2),[0,-10,5],[-15,10,15],[0,10,-25]],[lerp(150,a,.2),lerp(150,p,.2),lerp(150,t,.2),[0,-10,5],[15,10,15],[0,10,-25]],[lerp(130,a,.15),lerp(130,p,.15),lerp(130,t,.15),[0,-10,5],[-15,10,15],[15,10,15]]])fill(i,l,r),beginShape(),vertex(...o),vertex(...s),vertex(...n),endShape(CLOSE);pop();a=getAltitude(e.x,e.z);drawShipShadow(e.x,a,e.z,e.yaw,e.y)}function drawEnemies(e,t){var i,l=FOG_END*FOG_END;for(i of enemies){var r=i.x-e,o=i.z-t;if(!(l<r*r+o*o)){if(push(),translate(i.x,i.y,i.z),"fighter"===i.type){var r=i.vx||.1,o=i.vy||0,s=i.vz||.1,n=sqrt(r*r+o*o+s*s);0<n&&(r=atan2(r,s),rotateY(r),s=asin(o/n),rotateX(-s)),noStroke(),fill(255,150,0),beginShape(TRIANGLES),vertex(0,0,20),vertex(-15,0,-15),vertex(15,0,-15),vertex(0,0,20),vertex(-15,0,-15),vertex(0,-10,0),vertex(0,0,20),vertex(15,0,-15),vertex(0,-10,0),vertex(0,0,20),vertex(-15,0,-15),vertex(0,10,0),vertex(0,0,20),vertex(15,0,-15),vertex(0,10,0),endShape()}else{rotateY(.15*frameCount),noStroke();for(var[a,p]of[[-10,[220,30,30]],[6,[170,15,15]]])fill(...p),beginShape(TRIANGLES),vertex(0,a,-25),vertex(-22,0,0),vertex(22,0,0),vertex(0,a,25),vertex(-22,0,0),vertex(22,0,0),vertex(0,a,-25),vertex(-22,0,0),vertex(0,a,25),vertex(0,a,-25),vertex(22,0,0),vertex(0,a,25),endShape();fill(255,60,60),push(),translate(0,-14,0),box(3,14,3),pop()}pop(),drawShadow(i.x,getAltitude(i.x,i.z),i.z,"fighter"===i.type?25:40,"fighter"===i.type?25:40)}}}function updateEnemies(){var e,t,i,l,r,o,s,n=players.filter(e=>!e.dead).map(e=>e.ship),a=n[0]||players[0].ship;for(e of enemies)"fighter"===e.type?(r=findNearest(n,e.x,e.y,e.z).target,r=r||a,e.stateTimer=(e.stateTimer||0)+1,120<e.stateTimer&&(e.stateTimer=0,e.aggressive=.5<random(),e.aggressive||(e.wanderX=e.x+random(-1500,1500),e.wanderZ=e.z+random(-1500,1500))),l=e.aggressive?r.x:e.wanderX||e.x,o=e.aggressive?r.z:e.wanderZ||e.z,r=e.aggressive?r.y:-600,l=l-e.x,r=r-e.y,o=o-e.z,0<(t=sqrt(l*l+r*r+o*o))&&(e.vx=lerp(e.vx||0,l/t*2.5,.05),e.vy=lerp(e.vy||0,r/t*2.5,.05),e.vz=lerp(e.vz||0,o/t*2.5,.05)),i=getAltitude(e.x,e.z),e.y>i-150&&(e.vy-=.5),e.x+=e.vx,e.y+=e.vy,e.z+=e.vz,e.fireTimer++,e.aggressive&&t<1200&&90<e.fireTimer&&(e.fireTimer=0,i=l/t+random(-.2,.2),l=r/t+random(-.2,.2),r=o/t+random(-.2,.2),o=sqrt(i*i+l*l+r*r),enemyBullets.push({x:e.x,y:e.y,z:e.z,vx:i/o*10,vy:l/o*10,vz:r/o*10,life:120}))):(e.x+=e.vx,e.z+=e.vz,e.y+=2*sin(.05*frameCount+e.id),5e3<abs(e.x-a.x)&&(e.vx*=-1),5e3<abs(e.z-a.z)&&(e.vz*=-1),random()<.008&&(t=getAltitude(e.x,e.z),aboveSea(t)||(i=toTile(e.x),l=toTile(e.z),r=i*TILE,o=l*TILE,isLaunchpad(r,o))||(s=tileKey(i,l),infectedTiles[s])||bombs.push({x:e.x,y:e.y,z:e.z,k:s})))}function explosion(t,i,l){for(let e=0;e<40;e++)particles.push({x:t,y:i,z:l,vx:random(-8,8),vy:random(-8,8),vz:random(-8,8),life:255})}function keyPressed(){if("menu"===gameState)"1"===key?startGame(1):"2"===key&&startGame(2);else for(var e of players)keyCode===e.keys.missile&&fireMissile(e)}function touchStarted(e){return"menu"===gameState?(isAndroid&&!fullscreen()&&fullscreen(!0),setTimeout(()=>{startGame(1)},50)):"playing"===gameState&&isAndroid&&!fullscreen()&&fullscreen(!0),!1}function touchEnded(e){return!1}function touchMoved(e){return!1}function mousePressed(){isMobile||(fullscreen()||fullscreen(!0),"menu"===gameState?startGame(1):"playing"===gameState&&1===numPlayers&&requestPointerLock())}function mouseMoved(){"playing"!==gameState||1!==numPlayers||players[0].dead||isMobile||(players[0].ship.yaw-=.003*movedX,players[0].ship.pitch=constrain(players[0].ship.pitch-.003*movedY,-PI/2.2,PI/2.2))}function windowResized(){resizeCanvas(windowWidth,windowHeight)}